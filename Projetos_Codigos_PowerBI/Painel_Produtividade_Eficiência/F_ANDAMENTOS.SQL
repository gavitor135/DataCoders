WITH FichaFiltrada AS (
    SELECT PASTA, PRODUTO, DEPARTAMENTO
    FROM JURIDICO.FichaProcessual WITH(NOLOCK)
    WHERE DEPARTAMENTO = 'COBRANÃ‡A'
),
Andamentos AS (
    SELECT 
        ANDA.PASTA,
        ANDA.CHAVEANDA AS CHAVE,
        ANDA.DATA_CRIACAO_ANDAMENTO AS DATA_EVENTO,
        ANDA.TIPO_ANDAMENTO AS TIPO_EVENTO,
        ANDA.USUARIO_CADASTRO_ANDAMENTO AS USUARIO,
        FP.PRODUTO,
        'ANDAMENTO' AS ORIGEM
    FROM JURIDICO.ANDAMENTOS ANDA WITH(NOLOCK)
    INNER JOIN FichaFiltrada FP ON ANDA.PASTA = FP.PASTA
    WHERE 
        ANDA.DATA_CRIACAO_ANDAMENTO >= '01/01/2024'
        AND ANDA.USUARIO_CADASTRO_ANDAMENTO IS NOT NULL
        AND LEN(ANDA.USUARIO_CADASTRO_ANDAMENTO) > 0
        AND ANDA.USUARIO_CADASTRO_ANDAMENTO NOT IN ('TED', 'TEDESCO', 'TRIARE', '145')
        AND ANDA.USUARIO_CADASTRO_ANDAMENTO <> ' '
)

SELECT * FROM Andamentos;
