SELECT 
    FP.PASTA,
    FP.AREA,
    FP.DEPARTAMENTO,
    FP.FASE,
    FP.PROCESSO,
    FP.CARTEIRA,
    FP.PRODUTO,
    FP.ESTADO,
    FP.COMARCA,
    FP.TIPO_ACAO,
    FP.STATUS_PASTA,
    FP.DATA_CADASTRO_PASTA,
    FP.DATA_ENTRADA_PROC,
    FP.ASSUNTO,
    DATEADD(DAY, 10, FP.DATA_ENTRADA_PROC) AS [PRAZO 10 DIAS],
    DATEADD(DAY, 15, FP.DATA_ENTRADA_PROC) AS [PRAZO 15 DIAS],
    FP.DATA_TERCEIRIZACAO,
    FP.CASO_NOVO,
    FP.CASO_ANTIGO,
    FP.DATA_DO_AJUIZAMENTO,
    FP.PROCESSO,
    FP.VALOR_CAUSA,
    CASE
        WHEN FP.VALOR_CAUSA IS NULL THEN NULL
        WHEN FP.VALOR_CAUSA <= 1000000 THEN 'ATÉ 1 MILHÃO'
        WHEN FP.VALOR_CAUSA <= 2000000 THEN 'ATÉ 2 MILHÕES'
        WHEN FP.VALOR_CAUSA <= 3000000 THEN 'ATÉ 3 MILHÕES'
        WHEN FP.VALOR_CAUSA <= 4000000 THEN 'ATÉ 4 MILHÕES'
        WHEN FP.VALOR_CAUSA <= 5000000 THEN 'ATÉ 5 MILHÕES'
        WHEN FP.VALOR_CAUSA > 5000000 THEN 'MAIOR QUE 5 MILHÕES'
    END AS CLUSTER_VALOR_CAUSA
FROM Juridico.FichaProcessual FP WITH (NOLOCK)
WHERE FP.GRUPO = 'BB'
AND FP.TIPO_ACAO NOT IN (
    'CARTA PRECATÓRIA',
    'CARTA PRECATÓRIA - CASOS NÃO TERCEIRIZADOS',
    'CUMPRIMENTO DE SENTENCA',
    'EMBARGOS ',
    'EMBARGOS À ARREMATAÇÃO',
    'EMBARGOS À EXECUÇÃO',
    'EMBARGOS A EXECUÇÃO FISCAL',
    'EMBARGOS DE TERCEIRO',
    'FALENCIA',
    'INSOLVÊNCIA CIVIL',
    'PROTESTO POR PREFERENCIA',
    'RECLAMATÓRIA TRABALHISTA',
    'RECUPERACAO JUDICIAL',
    'RECUPERAÇÃO JUDICIAL',
    'RENOVATÓRIA DE LOCAÇÃO',
    'RESCISÓRIA',
    'TRABALHISTA')
AND FP.BJ != 'VERIFICAR'
AND FP.AREA != 'CONTENCIOSO CIVEL'
AND FP.CARTEIRA != 'RECUPERAÇÃO JUDICIAL'
AND FP.DEPARTAMENTO = 'COBRANÇA'
AND FP.CASO_NOVO = 'SIM'
AND FP.STATUS_PASTA = 'ATIVO'
AND (FP.DATA_DO_AJUIZAMENTO >= '01/01/2019' OR FP.DATA_DO_AJUIZAMENTO IS NULL)
AND ((
    FP.DATA_TERCEIRIZACAO >= '01/01/2019'
    OR (
        FP.DATA_TERCEIRIZACAO IS NULL 
        AND FP.PASTA IN (
            SELECT ANDA.PASTA
            FROM JURIDICO.ANDAMENTOS ANDA WITH (NOLOCK)
            WHERE ANDA.TIPO_ANDAMENTO IN ('TERCEIRIZAÇÃO', 'TERCEIRIZAÇÃO / MIGRAÇÃO')
        )
    )
))
AND (
    FP.PASTA NOT IN (
        SELECT ANDA.PASTA
        FROM JURIDICO.ANDAMENTOS ANDA WITH (NOLOCK)
        WHERE ANDA.TIPO_ANDAMENTO = 'MEDIDAS JUDICIAIS'
    )
    OR (
        FP.PASTA IN (
            SELECT ANDA.PASTA
            FROM JURIDICO.ANDAMENTOS ANDA WITH (NOLOCK)
            WHERE ANDA.TIPO_ANDAMENTO = 'PASTA REABERTA'
        )
        AND FP.PROCESSO IN ('XX/2019', 'XX/2020', 'XX/2021', 'XX/2022')
    )
)
AND (
    FP.PASTA NOT IN (
        SELECT  ANDA.PASTA
        FROM JURIDICO.ANDAMENTOS ANDA WITH (NOLOCK)
        WHERE ANDA.TIPO_ANDAMENTO = 'AÇÃO NÃO AJUIZADA'
        AND (
            ANDA.DATA_ANDAMENTO > (
                SELECT MAX(SUB_AND.DATA_ANDAMENTO)
                FROM JURIDICO.ANDAMENTOS SUB_AND WITH (NOLOCK)
                WHERE SUB_AND.PASTA = ANDA.PASTA
                AND SUB_AND.TIPO_ANDAMENTO IN ('PROTOCOLO DIGITAL EFETUADO – INICIAL', 'INICIAL PROTOCOLADA')
            )
            OR NOT EXISTS (
                SELECT MAX(SUB_AND.DATA_ANDAMENTO)
                FROM JURIDICO.ANDAMENTOS SUB_AND WITH (NOLOCK)
                WHERE SUB_AND.PASTA = ANDA.PASTA
                AND SUB_AND.TIPO_ANDAMENTO IN ('PROTOCOLO DIGITAL EFETUADO – INICIAL', 'INICIAL PROTOCOLADA')
            )
        )
    )
);


