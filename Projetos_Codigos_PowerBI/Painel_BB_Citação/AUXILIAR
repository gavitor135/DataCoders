SELECT
    FP.PASTA,
    FP.CARTEIRA,
    FP.PRODUTO,
    FP.ESTADO,
    FP.COMARCA,
    FP.TIPO_ACAO,
    FP.STATUS_PASTA,
    FP.DATA_CADASTRO_PASTA,
    FP.DATA_ENTRADA_PROC,
    FP.ASSUNTO,
    FP.DATA_TERCEIRIZACAO,
    FP.CASO_NOVO,
    FP.CASO_ANTIGO,
    FP.DATA_DO_AJUIZAMENTO,
    FP.PROCESSO,
    FP.VALOR_CAUSA,

    CASE
        WHEN FP.VALOR_CAUSA IS NULL THEN NULL
        WHEN FP.VALOR_CAUSA <= 1000000 THEN 'ATÉ 1 MILHÃO'
        WHEN FP.VALOR_CAUSA <= 2000000 THEN 'ATÉ 2 MILHÕES'
        WHEN FP.VALOR_CAUSA <= 3000000 THEN 'ATÉ 3 MILHÕES'
        WHEN FP.VALOR_CAUSA <= 4000000 THEN 'ATÉ 4 MILHÕES'
        WHEN FP.VALOR_CAUSA <= 5000000 THEN 'ATÉ 5 MILHÕES'
        WHEN FP.VALOR_CAUSA > 5000000 THEN 'MAIOR QUE 5 MILHÕES'
    END AS CLUSTER_VALOR_CAUSA,

    -- Andamentos específicos

            anda_CITACAO_POSITIVA.TIPO_ANDAMENTO AS AND_CITACAO_POSITIVA,
            anda_CITACAO_POSITIVA.DATA_ANDAMENTO AS DATA_AND_CITACAO_POSITIVA,

            anda_CITACAO_PARCIAL.TIPO_ANDAMENTO AS AND_CITACAO_PARCIAL,
            anda_CITACAO_PARCIAL.DATA_ANDAMENTO AS DATA_CITACAO_PARCIAL,

            anda_CITACAO_COMPARECIMENTO.TIPO_ANDAMENTO AS AND_CITACAO_COMPARECIMENTO,
            anda_CITACAO_COMPARECIMENTO.DATA_ANDAMENTO AS DATA_CITACAO_COMPARECIMENTO,

            anda_CITACAO_MANDADO_EXPEDIDO.TIPO_ANDAMENTO AS AND_CITACAO_MANDADO_EXPEDIDO,
            anda_CITACAO_MANDADO_EXPEDIDO.DATA_ANDAMENTO AS DATA_CITACAO_MANDADO_EXPEDIDO,

            anda_CITACAO_NEGATIVA_NOVO_ENDERECO.TIPO_ANDAMENTO AS AND_CITACAO_NEGATIVA_NOVO_ENDERECO,
            anda_CITACAO_NEGATIVA_NOVO_ENDERECO.DATA_ANDAMENTO AS DATA_CITACAO_NEGATIVA_NOVO_ENDERECO,

            anda_CITACAO_NEGATIVA_NOVO_MANDADO.TIPO_ANDAMENTO AS AND_CITACAO_NEGATIVA_NOVO_MANDADO,
            anda_CITACAO_NEGATIVA_NOVO_MANDADO.DATA_ANDAMENTO AS DATA_CITACAO_NEGATIVA_NOVO_MANDADO,

            anda_CITACAO_NEGATIVA_EDITAL_REQUERIDA.TIPO_ANDAMENTO AS AND_CITACAO_NEGATIVA_EDITAL_REQUERIDA,
            anda_CITACAO_NEGATIVA_EDITAL_REQUERIDA.DATA_ANDAMENTO AS DATA_CITACAO_NEGATIVA_EDITAL_REQUERIDA,

            anda_CITACAO_NEGATIVA_PESQUISA_ENDERECO.TIPO_ANDAMENTO AS AND_CITACAO_NEGATIVA_PESQUISA_ENDERECO,
            anda_CITACAO_NEGATIVA_PESQUISA_ENDERECO.DATA_ANDAMENTO AS DATA_CITACAO_NEGATIVA_PESQUISA_ENDERECO,

            anda_GESTAO_MANDADO_ACIONAMENTO_EMAIL.TIPO_ANDAMENTO AS AND_GESTAO_MANDADO_ACIONAMENTO_EMAIL,
            anda_GESTAO_MANDADO_ACIONAMENTO_EMAIL.DATA_ANDAMENTO AS DATA_GESTAO_MANDADO_ACIONAMENTO_EMAIL,

            anda_GESTAO_MANDADO_ACIONAMENTO_FONE.TIPO_ANDAMENTO AS AND_GESTAO_MANDADO_ACIONAMENTO_FONE,
            anda_GESTAO_MANDADO_ACIONAMENTO_FONE.DATA_ANDAMENTO AS DATA_GESTAO_MANDADO_ACIONAMENTO_FONE,

            anda_GESTAO_MANDADO_ACIONAMENTO_PETICAO.TIPO_ANDAMENTO AS AND_GESTAO_MANDADO_ACIONAMENTO_PETICAO,
            anda_GESTAO_MANDADO_ACIONAMENTO_PETICAO.DATA_ANDAMENTO AS DATA_GESTAO_MANDADO_ACIONAMENTO_PETICAO,

            anda_GESTAO_MANDADO_ACOMPANHAMENTO.TIPO_ANDAMENTO AS AND_GESTAO_MANDADO_ACOMPANHAMENTO,
            anda_GESTAO_MANDADO_ACOMPANHAMENTO.DATA_ANDAMENTO AS DATA_GESTAO_MANDADO_ACOMPANHAMENTO,

        anda_PETICAO_INDICACAO_ENDERECO.TIPO_ANDAMENTO AS AND_PETICAO_INDICACAO_ENDERECO,
        anda_PETICAO_INDICACAO_ENDERECO.DATA_ANDAMENTO AS DATA_PETICAO_INDICACAO_ENDERECO,

        anda_CITACAO_NEGATIVA.TIPO_ANDAMENTO AS AND_CITACAO_NEGATIVA,
        anda_CITACAO_NEGATIVA.DATA_ANDAMENTO AS DATA_CITACAO_NEGATIVA
    
FROM Juridico.FichaProcessual FP WITH (NOLOCK)

-- Andamento "CITAÇÃO POSITIVA"
LEFT JOIN (
    SELECT PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO, ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'CITAÇÃO POSITIVA'
) anda_CITACAO_POSITIVA
ON FP.PASTA = anda_CITACAO_POSITIVA.PASTA AND anda_CITACAO_POSITIVA.rn = 1

-- Andamento "CITAÇÃO PARCIAL"
LEFT JOIN (
    SELECT PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO, ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'CITAÇÃO PARCIAL'
) anda_CITACAO_PARCIAL
ON FP.PASTA = anda_CITACAO_PARCIAL.PASTA AND anda_CITACAO_PARCIAL.rn = 1

-- Andamento "CITAÇÃO - COMPARECIMENTO ESPONTANEO"
LEFT JOIN (
    SELECT PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO, ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'CITAÇÃO - COMPARECIMENTO ESPONTANEO'
) anda_CITACAO_COMPARECIMENTO
ON FP.PASTA = anda_CITACAO_COMPARECIMENTO.PASTA AND anda_CITACAO_COMPARECIMENTO.rn = 1

                -- Andamento "CITAÇÃO - MANDADO EXPEDIDO"
                LEFT JOIN (
                    SELECT PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO, ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
                    FROM Juridico.Andamentos
                    WHERE TIPO_ANDAMENTO = 'CITAÇÃO - MANDADO EXPEDIDO'
                ) anda_CITACAO_MANDADO_EXPEDIDO
                ON FP.PASTA = anda_CITACAO_MANDADO_EXPEDIDO.PASTA AND anda_CITACAO_MANDADO_EXPEDIDO.rn = 1

            -- Andamento "CITAÇÃO NEGATIVA - NOVO ENDEREÇO INFORMANDO"
            LEFT JOIN (
                SELECT PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO, ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
                FROM Juridico.Andamentos
                WHERE TIPO_ANDAMENTO = 'CITAÇÃO NEGATIVA - NOVO ENDEREÇO INFORMANDO'
            ) anda_CITACAO_NEGATIVA_NOVO_ENDERECO
            ON FP.PASTA = anda_CITACAO_NEGATIVA_NOVO_ENDERECO.PASTA AND anda_CITACAO_NEGATIVA_NOVO_ENDERECO.rn = 1

        -- Andamento "CITAÇÃO NEGATIVA - NOVO MANDADO EXPEDIDO"
        LEFT JOIN (
            SELECT PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO, ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
            FROM Juridico.Andamentos
            WHERE TIPO_ANDAMENTO = 'CITAÇÃO NEGATIVA - NOVO MANDADO EXPEDIDO'
        ) anda_CITACAO_NEGATIVA_NOVO_MANDADO
        ON FP.PASTA = anda_CITACAO_NEGATIVA_NOVO_MANDADO.PASTA AND anda_CITACAO_NEGATIVA_NOVO_MANDADO.rn = 1

            -- Andamento "CITAÇÃO NEGATIVA - CITAÇÃO POR EDITAL REQUERIDA AO JUIZO"
            LEFT JOIN (
                SELECT PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO, ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
                FROM Juridico.Andamentos
                WHERE TIPO_ANDAMENTO = 'CITAÇÃO NEGATIVA - CITAÇÃO POR EDITAL REQUERIDA AO JUIZO'
            ) anda_CITACAO_NEGATIVA_EDITAL_REQUERIDA
            ON FP.PASTA = anda_CITACAO_NEGATIVA_EDITAL_REQUERIDA.PASTA AND anda_CITACAO_NEGATIVA_EDITAL_REQUERIDA.rn = 1

        -- Andamento "CITAÇÃO NEGATIVA - PESQUISA DE ENDEREÇO"
        LEFT JOIN (
            SELECT PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO, ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
            FROM Juridico.Andamentos
            WHERE TIPO_ANDAMENTO = 'CITAÇÃO NEGATIVA - PESQUISA DE ENDEREÇO'
        ) anda_CITACAO_NEGATIVA_PESQUISA_ENDERECO
        ON FP.PASTA = anda_CITACAO_NEGATIVA_PESQUISA_ENDERECO.PASTA AND anda_CITACAO_NEGATIVA_PESQUISA_ENDERECO.rn = 1

        -- Andamento "GESTÃO DE MANDADO - ACIONAMENTO VIA E-MAIL REALIZADO"
        LEFT JOIN (
            SELECT PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO, ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
            FROM Juridico.Andamentos
            WHERE TIPO_ANDAMENTO = 'GESTÃO DE MANDADO - ACIONAMENTO VIA E-MAIL REALIZADO'
        ) anda_GESTAO_MANDADO_ACIONAMENTO_EMAIL
        ON FP.PASTA = anda_GESTAO_MANDADO_ACIONAMENTO_EMAIL.PASTA AND anda_GESTAO_MANDADO_ACIONAMENTO_EMAIL.rn = 1

        -- Andamento "GESTÃO DE MANDADO - ACIONAMENTO VIA FONE REALIZADO"
        LEFT JOIN (
            SELECT PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO, ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
            FROM Juridico.Andamentos
            WHERE TIPO_ANDAMENTO = 'GESTÃO DE MANDADO - ACIONAMENTO VIA FONE REALIZADO'
        ) anda_GESTAO_MANDADO_ACIONAMENTO_FONE
        ON FP.PASTA = anda_GESTAO_MANDADO_ACIONAMENTO_FONE.PASTA AND anda_GESTAO_MANDADO_ACIONAMENTO_FONE.rn = 1

        -- Andamento "GESTÃO DE MANDADO - ACIONAMENTO VIA PETIÇÃO REALIZADO"
        LEFT JOIN (
            SELECT PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO, ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
            FROM Juridico.Andamentos
            WHERE TIPO_ANDAMENTO = 'GESTÃO DE MANDADO - ACIONAMENTO VIA PETIÇÃO REALIZADO'
        ) anda_GESTAO_MANDADO_ACIONAMENTO_PETICAO
        ON FP.PASTA = anda_GESTAO_MANDADO_ACIONAMENTO_PETICAO.PASTA AND anda_GESTAO_MANDADO_ACIONAMENTO_PETICAO.rn = 1

-- Andamento "GESTÃO DE MANDADO - ACOMPANHAMENTO"
LEFT JOIN (
    SELECT PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO, ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'GESTÃO DE MANDADO - ACOMPANHAMENTO'
) anda_GESTAO_MANDADO_ACOMPANHAMENTO
ON FP.PASTA = anda_GESTAO_MANDADO_ACOMPANHAMENTO.PASTA AND anda_GESTAO_MANDADO_ACOMPANHAMENTO.rn = 1

-- Andamento "PETIÇÃO DE INDICAÇÃO DE ENDEREÇO"
LEFT JOIN (
    SELECT PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO, ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'PETIÇÃO DE INDICAÇÃO DE ENDEREÇO'
) anda_PETICAO_INDICACAO_ENDERECO
ON FP.PASTA = anda_PETICAO_INDICACAO_ENDERECO.PASTA AND anda_PETICAO_INDICACAO_ENDERECO.rn = 1

-- Andamento "CITAÇÃO NEGATIVA"
LEFT JOIN (
    SELECT PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO, ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'CITAÇÃO NEGATIVA'
) anda_CITACAO_NEGATIVA
ON FP.PASTA = anda_CITACAO_NEGATIVA.PASTA AND anda_CITACAO_NEGATIVA.rn = 1

---- Compromisso "VALIDAR PETIÇÃO"
--LEFT JOIN (
--    SELECT PASTA, TIPO_COMPROMISSO,STATUS_COMPROMISSO, DATA_LIMITE_COMPROMISSO,DATA_CADASTRO_COMPROMISO,
--    ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_LIMITE_COMPROMISSO DESC) AS rn
--    FROM Juridico.Compromissos
--    WHERE TIPO_COMPROMISSO = 'VALIDAR PETIÇÃO INICIAL'
--) comp_VALIDAR_PETICAO
--ON FP.PASTA = comp_VALIDAR_PETICAO.PASTA AND comp_VALIDAR_PETICAO.rn = 1

WHERE FP.PRODUTO IN (
    'BANCO DO BRASIL - COBRANÇA - SEGMENTO 1',
    'BANCO DO BRASIL - COBRANÇA - SEGMENTO 2',
    'BANCO DO BRASIL - COBRANÇA - SEGMENTO 3',
    'BB - COBRANÇA',
    'BANCO DO BRASIL - COBRANÇA - ATIPICAS')

AND FP.DATA_DO_AJUIZAMENTO IS NOT NULL


