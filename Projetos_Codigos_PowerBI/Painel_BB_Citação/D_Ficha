WITH FICHABB AS (
    SELECT 
        FP.PASTA,
        FP.CARTEIRA,
        FP.PRODUTO,
        FP.ESTADO,
        FP.COMARCA,
        FP.TIPO_ACAO,
        FP.STATUS_PASTA,
        FP.DATA_CADASTRO_PASTA,
        FP.DATA_ENTRADA_PROC,
        FP.ASSUNTO,
        FP.DATA_TERCEIRIZACAO,
        FP.CASO_NOVO,
        FP.CASO_ANTIGO,
        FP.DATA_DO_AJUIZAMENTO,
        FP.PROCESSO,
        FP.VALOR_CAUSA,
        FP.SITUACAO_BB,
        FP.FRENTE_RECUPERA_BB
    FROM JURIDICO.FICHAPROCESSUAL FP WITH (NOLOCK)
    WHERE FP.PRODUTO IN (
            'BANCO DO BRASIL - COBRANÇA - SEGMENTO 1',
            'BANCO DO BRASIL - COBRANÇA - SEGMENTO 2',
            'BANCO DO BRASIL - COBRANÇA - SEGMENTO 3',
            'BB - COBRANÇA',
            'BANCO DO BRASIL - COBRANÇA - ATIPICAS'
    )
      AND FP.DATA_DO_AJUIZAMENTO IS NOT NULL
)
SELECT
    FP.PASTA,
    FP.CARTEIRA,
    FP.PRODUTO,
    FP.ESTADO,
    FP.COMARCA,
    FP.TIPO_ACAO,
    FP.STATUS_PASTA,
    FP.DATA_CADASTRO_PASTA,
    FP.DATA_ENTRADA_PROC,
    FP.ASSUNTO,
    FP.DATA_TERCEIRIZACAO,
    FP.CASO_NOVO,
    FP.CASO_ANTIGO,
    FP.DATA_DO_AJUIZAMENTO,
    FP.PROCESSO,
    FP.VALOR_CAUSA,
    FP.SITUACAO_BB,
    FP.FRENTE_RECUPERA_BB,
    YEAR(MINDATECIT.MIN_DATA) AS ANO_CITACAO,

    -- Cluster de Valor da Causa
    CASE
        WHEN FP.VALOR_CAUSA IS NULL THEN NULL
        WHEN FP.VALOR_CAUSA <= 1000000 THEN 'ATÉ 1 MILHÃO'
        WHEN FP.VALOR_CAUSA <= 2000000 THEN 'ATÉ 2 MILHÕES'
        WHEN FP.VALOR_CAUSA <= 3000000 THEN 'ATÉ 3 MILHÕES'
        WHEN FP.VALOR_CAUSA <= 4000000 THEN 'ATÉ 4 MILHÕES'
        WHEN FP.VALOR_CAUSA <= 5000000 THEN 'ATÉ 5 MILHÕES'
        WHEN FP.VALOR_CAUSA > 5000000 THEN 'MAIOR QUE 5 MILHÕES'
    END AS CLUSTER_VALOR_CAUSA,

    -- Cluster para tipos de Ação
    CASE
        WHEN FP.TIPO_ACAO IN (
        'COBRANÇA',
        'EXECUÇÃO',
        'EXECUÇÃO DE TITULO EXTRAJUDICIAL',
        'EXECUCAO HIPOTECARIA',
        'MONITÓRIA',
        'ORDINARIA DE COBRANCA',
        'PROCEDIMENTO COMUM',
        'PROCEDIMENTO ORDINÁRIO')
        THEN 'AÇÕES APTAS'
        ELSE 'AÇÕES NÃO APTAS'
        END AS TIPO_ACAO_AJUSTADA,

    -- SLA Pendente Citação: Se os três andamentos estão nulos, calcula o DATEDIFF; caso contrário, retorna "CITADO"
    CASE
        WHEN anda_CITACAO_POSITIVA.TIPO_ANDAMENTO IS NULL
             AND anda_CITACAO_PARCIAL.TIPO_ANDAMENTO IS NULL
             AND anda_CITACAO_COMPARECIMENTO.TIPO_ANDAMENTO IS NULL
        THEN
            CASE
                WHEN DATEDIFF(DAY, FP.DATA_DO_AJUIZAMENTO, GETDATE()) <= 45  THEN 'ATÉ 45 DIAS'
                WHEN DATEDIFF(DAY, FP.DATA_DO_AJUIZAMENTO, GETDATE()) <= 60  THEN 'ATÉ 60 DIAS'
                WHEN DATEDIFF(DAY, FP.DATA_DO_AJUIZAMENTO, GETDATE()) <= 90  THEN 'ATÉ 90 DIAS'
                WHEN DATEDIFF(DAY, FP.DATA_DO_AJUIZAMENTO, GETDATE()) <= 120 THEN 'ATÉ 120 DIAS'
                WHEN DATEDIFF(DAY, FP.DATA_DO_AJUIZAMENTO, GETDATE()) <= 180 THEN 'ATÉ 6 MESES'
                WHEN DATEDIFF(DAY, FP.DATA_DO_AJUIZAMENTO, GETDATE()) <= 365 THEN 'ATÉ 1 ANO'
                WHEN DATEDIFF(DAY, FP.DATA_DO_AJUIZAMENTO, GETDATE()) <= 730 THEN 'ATÉ 2 ANOS'
                ELSE 'MAIOR QUE 2 ANOS'
            END
        ELSE 'CITADO'
    END AS CLUSTER_SLA_PENDENTE_CITAÇÃO,

    -- Cluster SLA 1º Citação: Com base na menor data de citação
    CASE
        WHEN MINDATECIT.MIN_DATA IS NULL THEN NULL
        WHEN YEAR(MINDATECIT.MIN_DATA) = 1919 THEN 'CITAÇÃO SEM DATA'
        WHEN DATEDIFF(DAY, FP.DATA_DO_AJUIZAMENTO, MINDATECIT.MIN_DATA) <= 45 THEN 'ATÉ 45 DIAS'
        WHEN DATEDIFF(DAY, FP.DATA_DO_AJUIZAMENTO, MINDATECIT.MIN_DATA) <= 60 THEN 'ATÉ 60 DIAS'
        WHEN DATEDIFF(DAY, FP.DATA_DO_AJUIZAMENTO, MINDATECIT.MIN_DATA) <= 90 THEN 'ATÉ 90 DIAS'
        WHEN DATEDIFF(DAY, FP.DATA_DO_AJUIZAMENTO, MINDATECIT.MIN_DATA) <= 120 THEN 'ATÉ 120 DIAS'
        WHEN DATEDIFF(DAY, FP.DATA_DO_AJUIZAMENTO, MINDATECIT.MIN_DATA) <= 180 THEN 'ATÉ 6 MESES'
        WHEN DATEDIFF(DAY, FP.DATA_DO_AJUIZAMENTO, MINDATECIT.MIN_DATA) <= 365 THEN 'ATÉ 1 ANO'
        WHEN DATEDIFF(DAY, FP.DATA_DO_AJUIZAMENTO, MINDATECIT.MIN_DATA) <= 730 THEN 'ATÉ 2 ANOS'
        ELSE 'MAIOR QUE 2 ANOS'
    END AS CLUSTER_SLA_1º_CITACAO,

    -- SLA da Citação: Diferença em dias
    CASE
        WHEN MINDATECIT.MIN_DATA IS NULL THEN NULL
        ELSE DATEDIFF(DAY, FP.DATA_DO_AJUIZAMENTO, MINDATECIT.MIN_DATA)
    END AS SLA_CITACAO,

    --- JUNÇÃO DE CASO NOVO E CASO ANTIGO
    CASE 
        WHEN FP.CASO_NOVO = 'SIM'
        THEN 'CASO NOVO'
        WHEN FP.CASO_ANTIGO = 'SIM'
        THEN 'CASO ANTIGO'
        ELSE 'VERIFICAR'
        END AS CASO_NOVO_ANTIGO,

    CASE 
        WHEN ANDA_ACORDO_REALIZADO.TIPO_ANDAMENTO IS NOT NULL
        THEN 'ACORDO FORMALIZADO'
        WHEN ANDA_ACORDO_REALIZADO.TIPO_ANDAMENTO IS NULL
        THEN 'SEM ACORDO'
        ELSE NULL
        END AS COM_ACORDO_FORMALIZADO,

    -- Andamentos específicos
    anda_CITACAO_POSITIVA.TIPO_ANDAMENTO AS AND_CITACAO_POSITIVA,
    anda_CITACAO_POSITIVA.DATA_ANDAMENTO AS DATA_AND_CITACAO_POSITIVA,

    anda_CITACAO_PARCIAL.TIPO_ANDAMENTO AS AND_CITACAO_PARCIAL,
    anda_CITACAO_PARCIAL.DATA_ANDAMENTO AS DATA_CITACAO_PARCIAL,

    anda_CITACAO_COMPARECIMENTO.TIPO_ANDAMENTO AS AND_CITACAO_COMPARECIMENTO,
    anda_CITACAO_COMPARECIMENTO.DATA_ANDAMENTO AS DATA_CITACAO_COMPARECIMENTO,

    anda_CITACAO_MANDADO_EXPEDIDO.TIPO_ANDAMENTO AS AND_CITACAO_MANDADO_EXPEDIDO,
    anda_CITACAO_MANDADO_EXPEDIDO.DATA_ANDAMENTO AS DATA_CITACAO_MANDADO_EXPEDIDO,

    anda_CITACAO_NEGATIVA_NOVO_ENDERECO.TIPO_ANDAMENTO AS AND_CITACAO_NEGATIVA_NOVO_ENDERECO,
    anda_CITACAO_NEGATIVA_NOVO_ENDERECO.DATA_ANDAMENTO AS DATA_CITACAO_NEGATIVA_NOVO_ENDERECO,

    anda_CITACAO_NEGATIVA_NOVO_MANDADO.TIPO_ANDAMENTO AS AND_CITACAO_NEGATIVA_NOVO_MANDADO,
    anda_CITACAO_NEGATIVA_NOVO_MANDADO.DATA_ANDAMENTO AS DATA_CITACAO_NEGATIVA_NOVO_MANDADO,

    anda_CITACAO_NEGATIVA_EDITAL_REQUERIDA.TIPO_ANDAMENTO AS AND_CITACAO_NEGATIVA_EDITAL_REQUERIDA,
    anda_CITACAO_NEGATIVA_EDITAL_REQUERIDA.DATA_ANDAMENTO AS DATA_CITACAO_NEGATIVA_EDITAL_REQUERIDA,

    anda_CITACAO_NEGATIVA_PESQUISA_ENDERECO.TIPO_ANDAMENTO AS AND_CITACAO_NEGATIVA_PESQUISA_ENDERECO,
    anda_CITACAO_NEGATIVA_PESQUISA_ENDERECO.DATA_ANDAMENTO AS DATA_CITACAO_NEGATIVA_PESQUISA_ENDERECO,

    anda_GESTAO_MANDADO_ACIONAMENTO_EMAIL.TIPO_ANDAMENTO AS AND_GESTAO_MANDADO_ACIONAMENTO_EMAIL,
    anda_GESTAO_MANDADO_ACIONAMENTO_EMAIL.DATA_ANDAMENTO AS DATA_GESTAO_MANDADO_ACIONAMENTO_EMAIL,

    anda_GESTAO_MANDADO_ACIONAMENTO_FONE.TIPO_ANDAMENTO AS AND_GESTAO_MANDADO_ACIONAMENTO_FONE,
    anda_GESTAO_MANDADO_ACIONAMENTO_FONE.DATA_ANDAMENTO AS DATA_GESTAO_MANDADO_ACIONAMENTO_FONE,

    anda_GESTAO_MANDADO_ACIONAMENTO_PETICAO.TIPO_ANDAMENTO AS AND_GESTAO_MANDADO_ACIONAMENTO_PETICAO,
    anda_GESTAO_MANDADO_ACIONAMENTO_PETICAO.DATA_ANDAMENTO AS DATA_GESTAO_MANDADO_ACIONAMENTO_PETICAO,

    anda_GESTAO_MANDADO_ACOMPANHAMENTO.TIPO_ANDAMENTO AS AND_GESTAO_MANDADO_ACOMPANHAMENTO,
    anda_GESTAO_MANDADO_ACOMPANHAMENTO.DATA_ANDAMENTO AS DATA_GESTAO_MANDADO_ACOMPANHAMENTO,

    anda_PETICAO_INDICACAO_ENDERECO.TIPO_ANDAMENTO AS AND_PETICAO_INDICACAO_ENDERECO,
    anda_PETICAO_INDICACAO_ENDERECO.DATA_ANDAMENTO AS DATA_PETICAO_INDICACAO_ENDERECO,

    anda_CITACAO_NEGATIVA.TIPO_ANDAMENTO AS AND_CITACAO_NEGATIVA,
    anda_CITACAO_NEGATIVA.DATA_ANDAMENTO AS DATA_CITACAO_NEGATIVA,

    anda_CITACOES_REALIZADAS.TIPO_ANDAMENTO AS MAIS_RECENTE_AND_CITACAO_REALIZADA,
    anda_CITACOES_REALIZADAS.DATA_ANDAMENTO AS DATA_MAIS_RECENTE_AND_CITACAO_REALIZADA,

    anda_ACORDO_REALIZADO.TIPO_ANDAMENTO AS AND_ACORDO_REALIZADO,
    anda_ACORDO_REALIZADO.DATA_ANDAMENTO AS DATA_AND_ACORDO_REALIZADO,

    anda_INDICIOS_CITACAO.TIPO_ANDAMENTO AS AND_INDICIOS_CITACAO,
    anda_INDICIOS_CITACAO.DATA_ANDAMENTO AS DATA_AND_INDICIOS_CITACAO,

    -- Tarefa de Encerramento TRIARE
    TAR_TRIARE.TAREFA AS TAREFA_TRIARE,
    TAR_TRIARE.DATA_CRIACAO_TAREFA AS DATA_CRIACAO_TAREFA_TRIARE,

    -- Primeira Data de Citação (entre parcial, positiva e comparecimento)
    MINDATECIT.MIN_DATA AS DATA_PRIMEIRA_CITAÇÃO,

    -- Verificação de Pendência de Citação
    CITPEN.PENDENTE_CIT AS PENDENTE_CITAÇÃO,
    CITPEN.TIPO_ANDAMENTO AS ANDAMENTO_PENDENCIA_CITAÇÃO,
    CITPEN.DATA_ANDAMENTO AS DATA_ANDAMENTO_PENDENCIA_CITAÇÃO

FROM FICHABB FP WITH (NOLOCK)

-- Andamento "CITAÇÃO POSITIVA"
LEFT JOIN (
    SELECT 
        PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'CITAÇÃO POSITIVA'
) anda_CITACAO_POSITIVA
    ON FP.PASTA = anda_CITACAO_POSITIVA.PASTA 
   AND anda_CITACAO_POSITIVA.rn = 1

-- Andamento "CITAÇÃO PARCIAL"
LEFT JOIN (
    SELECT 
        PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'CITAÇÃO PARCIAL'
) anda_CITACAO_PARCIAL
    ON FP.PASTA = anda_CITACAO_PARCIAL.PASTA 
   AND anda_CITACAO_PARCIAL.rn = 1

-- Andamento "CITAÇÃO - COMPARECIMENTO ESPONTANEO"
LEFT JOIN (
    SELECT 
        PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'CITAÇÃO - COMPARECIMENTO ESPONTANEO'
) anda_CITACAO_COMPARECIMENTO
    ON FP.PASTA = anda_CITACAO_COMPARECIMENTO.PASTA 
   AND anda_CITACAO_COMPARECIMENTO.rn = 1

-- Andamento "CITAÇÃO - MANDADO EXPEDIDO"
LEFT JOIN (
    SELECT 
        PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'CITAÇÃO - MANDADO EXPEDIDO'
) anda_CITACAO_MANDADO_EXPEDIDO
    ON FP.PASTA = anda_CITACAO_MANDADO_EXPEDIDO.PASTA 
   AND anda_CITACAO_MANDADO_EXPEDIDO.rn = 1

-- Andamento "CITAÇÃO NEGATIVA - NOVO ENDEREÇO INFORMANDO"
LEFT JOIN (
    SELECT 
        PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'CITAÇÃO NEGATIVA - NOVO ENDEREÇO INFORMANDO'
) anda_CITACAO_NEGATIVA_NOVO_ENDERECO
    ON FP.PASTA = anda_CITACAO_NEGATIVA_NOVO_ENDERECO.PASTA 
   AND anda_CITACAO_NEGATIVA_NOVO_ENDERECO.rn = 1

-- Andamento "CITAÇÃO NEGATIVA - NOVO MANDADO EXPEDIDO"
LEFT JOIN (
    SELECT 
        PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'CITAÇÃO NEGATIVA - NOVO MANDADO EXPEDIDO'
) anda_CITACAO_NEGATIVA_NOVO_MANDADO
    ON FP.PASTA = anda_CITACAO_NEGATIVA_NOVO_MANDADO.PASTA 
   AND anda_CITACAO_NEGATIVA_NOVO_MANDADO.rn = 1

-- Andamento "CITAÇÃO NEGATIVA - CITAÇÃO POR EDITAL REQUERIDA AO JUIZO"
LEFT JOIN (
    SELECT 
        PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'CITAÇÃO NEGATIVA - CITAÇÃO POR EDITAL REQUERIDA AO JUIZO'
) anda_CITACAO_NEGATIVA_EDITAL_REQUERIDA
    ON FP.PASTA = anda_CITACAO_NEGATIVA_EDITAL_REQUERIDA.PASTA 
   AND anda_CITACAO_NEGATIVA_EDITAL_REQUERIDA.rn = 1

-- Andamento "CITAÇÃO NEGATIVA - PESQUISA DE ENDEREÇO"
LEFT JOIN (
    SELECT 
        PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'CITAÇÃO NEGATIVA - PESQUISA DE ENDEREÇO'
) anda_CITACAO_NEGATIVA_PESQUISA_ENDERECO
    ON FP.PASTA = anda_CITACAO_NEGATIVA_PESQUISA_ENDERECO.PASTA 
   AND anda_CITACAO_NEGATIVA_PESQUISA_ENDERECO.rn = 1

-- Andamento "GESTÃO DE MANDADO - ACIONAMENTO VIA E-MAIL REALIZADO"
LEFT JOIN (
    SELECT 
        PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'GESTÃO DE MANDADO - ACIONAMENTO VIA E-MAIL REALIZADO'
) anda_GESTAO_MANDADO_ACIONAMENTO_EMAIL
    ON FP.PASTA = anda_GESTAO_MANDADO_ACIONAMENTO_EMAIL.PASTA 
   AND anda_GESTAO_MANDADO_ACIONAMENTO_EMAIL.rn = 1

-- Andamento "GESTÃO DE MANDADO - ACIONAMENTO VIA FONE REALIZADO"
LEFT JOIN (
    SELECT 
        PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'GESTÃO DE MANDADO - ACIONAMENTO VIA FONE REALIZADO'
) anda_GESTAO_MANDADO_ACIONAMENTO_FONE
    ON FP.PASTA = anda_GESTAO_MANDADO_ACIONAMENTO_FONE.PASTA 
   AND anda_GESTAO_MANDADO_ACIONAMENTO_FONE.rn = 1

-- Andamento "GESTÃO DE MANDADO - ACIONAMENTO VIA PETIÇÃO REALIZADO"
LEFT JOIN (
    SELECT 
        PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'GESTÃO DE MANDADO - ACIONAMENTO VIA PETIÇÃO REALIZADO'
) anda_GESTAO_MANDADO_ACIONAMENTO_PETICAO
    ON FP.PASTA = anda_GESTAO_MANDADO_ACIONAMENTO_PETICAO.PASTA 
   AND anda_GESTAO_MANDADO_ACIONAMENTO_PETICAO.rn = 1

-- Andamento "GESTÃO DE MANDADO - ACOMPANHAMENTO"
LEFT JOIN (
    SELECT 
        PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'GESTÃO DE MANDADO - ACOMPANHAMENTO'
) anda_GESTAO_MANDADO_ACOMPANHAMENTO
    ON FP.PASTA = anda_GESTAO_MANDADO_ACOMPANHAMENTO.PASTA 
   AND anda_GESTAO_MANDADO_ACOMPANHAMENTO.rn = 1

-- Andamento "PETIÇÃO DE INDICAÇÃO DE ENDEREÇO"
LEFT JOIN (
    SELECT 
        PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'PETIÇÃO DE INDICAÇÃO DE ENDEREÇO'
) anda_PETICAO_INDICACAO_ENDERECO
    ON FP.PASTA = anda_PETICAO_INDICACAO_ENDERECO.PASTA 
   AND anda_PETICAO_INDICACAO_ENDERECO.rn = 1

-- Andamento "CITAÇÃO NEGATIVA"
LEFT JOIN (
    SELECT 
        PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
    FROM Juridico.Andamentos
    WHERE TIPO_ANDAMENTO = 'CITAÇÃO NEGATIVA'
) anda_CITACAO_NEGATIVA
    ON FP.PASTA = anda_CITACAO_NEGATIVA.PASTA 
   AND anda_CITACAO_NEGATIVA.rn = 1

-- Andamento "ACORDO FORMALIZADO"
LEFT JOIN (
    SELECT 
        PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
        FROM Juridico.Andamentos
        WHERE TIPO_ANDAMENTO IN ('BB - QUEBRA DE ACORDO','ACORDO - NEGOCIAÇÃO FECHADA')
) anda_ACORDO_REALIZADO
        ON FP.PASTA = anda_ACORDO_REALIZADO.PASTA 
        AND anda_ACORDO_REALIZADO.rn = 1

-- Andamento "CASOS COM CITAÇÕES"
 LEFT JOIN (
     SELECT 
         PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
         ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
     FROM Juridico.Andamentos
     WHERE TIPO_ANDAMENTO IN (
     'CITAÇÃO PARCIAL',
     'CITAÇÃO - COMPARECIMENTO ESPONTANEO',
     'CITAÇÃO POSITIVA')
 ) anda_CITACOES_REALIZADAS
     ON FP.PASTA = anda_CITACOES_REALIZADAS.PASTA 
 AND anda_CITACOES_REALIZADAS.rn = 1


-- Andamento "CASOS COM INDICIO DE CITAÇÃO
 LEFT JOIN (
     SELECT 
         PASTA, TIPO_ANDAMENTO, DATA_ANDAMENTO,
         ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_ANDAMENTO DESC, HORA_ANDAMENTO DESC) AS rn
     FROM Juridico.Andamentos
     WHERE TIPO_ANDAMENTO IN (
        'ACOMPANHAMENTO - PENHORA BB',
        'ACOMPANHAMENTO – PENHORA BB MÓVEIS',
        'ACOMPANHAMENTO – PENHORA BB VALORES',
        'ACÓRDÃO - AÇÃO IMPROCEDENTE',
        'ACÓRDÃO - AÇÃO PARCIALMENTE PROCEDENTE',
        'ACÓRDÃO - AÇÃO PROCEDENTE',
        'ACÓRDÃO - EXTINÇÃO SEM MÉRITO',
        'ACORDAO (RECURSO NAO CONHECIDO POR DESERTO)',
        'ACÓRDÃO EMBARGOS IMPROCEDENTES',
        'ACÓRDÃO EMBARGOS PARCIALMENTE PROCEDENTES',
        'ACÓRDÃO NÃO PROVIDO',
        'ACÓRDÃO PARCIALMENTE PROVIDO',
        'ACÓRDÃO PROVIDO',
        'ADJUDICAÇÃO',
        'AGRAVO DE DESPACHO DENEGATÓRIO DE RECURSO ESPECIAL',
        'AGRAVO EM RECURSO ESPECIAL',
        'AGUARDANDO EXPEDIÇÃO DO MANDADO DE LEVANTAMENTO ELETRÔNICO',
        'AGUARDANDO RECEBIMENTO – BOLETO ARISP',
        'APELAÇÃO',
        'ARREMATAÇÃO',
        'AUTO DE ARREMATAÇÃO',
        'BACENJUD POSITIVO',
        'BEM ARREMATADO',
        'CARTA DE ADJUDICAÇÃO',
        'CARTA DE ARREMATACAO',
        'CARTA PRECATORIA - HASTA PUBLICA',
        'CONTESTAÇÃO',
        'CONTRA-RAZOES AGRAVO DE DESPACHO DENEGATORIO DE RECURSO ESPECIAL',
        'CONTRA-RAZOES DE RECURSO ESPECIAL',
        'CONTRARRAZÕES DE APELAÇÃO',
        'CONTRARRAZÕES DE RECURSO ESPECIAL',
        'CONTRATUAL RECEBIDO',
        'DATA DA HASTA',
        'DATA DA HASTA - 1º LEILÃO/PRAÇA',
        'DATA DA HASTA - 2º LEILÃO/PRAÇA',
        'Desconstituição Da Penhora',
        'DILIGENCIA - RETIRADA DE MLJ',
        'DILIGENCIA - RETIRADA DE MLJ ACORDO',
        'DILIGENCIA - RETIRADA DE MLJ BANCO RÉU',
        'DISPENSA DE RECURSO - AUTO DISPENSA',
        'DISPENSA RECURSAL AUTORIZADA',
        'EDITAL DE PRAÇA/HASTA PUBLICA',
        'EMBARGOS À ADJUDICAÇÃO',
        'EMBARGOS À ARREMATAÇÃO',
        'EMBARGOS À EXECUÇÃO',
        'EMBARGOS MONITÓRIOS',
        'FORMULARIO MLE JUNTADO',
        'HASTA PÚBLICA - NEGATIVA',
        'HASTA PÚBLICA - POSITIVA',
        'HASTA PÚBLICA - POSITIVA/NEGATIVA',
        'HASTA PÚBLICA MARCADA',
        'HASTA PÚBLICA REALIZADA - BENS ARREMATADOS',
        'HASTA PÚBLICA REALIZADA - NEGATIVA',
        'HASTA PÚBLICA REALIZADA SEM LICITANTES',
        'HASTA PÚBLICA REMARCADA',
        'HASTA PÚBLICA SUSPENSA',
        'IMÓVEL ARREMATADO',
        'IMPUGNAÇÃO AOS EMBARGOS',
        'IMPUGNAÇÃO AOS EMBARGOS A EXECUÇÃO',
        'IMPUGNAÇÃO AOS EMBARGOS DE EXECUÇÃO (H)',
        'Indicação De Bens - Penhora BB',
        'INFOJUD - DEFERIDO',
        'INFOJUD - EVOLUÇÃO PATRIMONIAL',
        'INFOJUD DITR - NEGATIVO',
        'INFOJUD DITR - POSITIVO',
        'INFOJUD DOI - NEGATIVO',
        'INFOJUD DOI - POSITIVO',
        'INFOJUD IR - NEGATIVO',
        'INFOJUD IR - POSITIVO',
        'INFORMAÇÕES ADICIONAIS - MLJ',
        'LAUDO DE AVALIAÇÃO',
        'MANDADO DE CITAÇÃO, PENHORA E AVALIAÇÃO',
        'MANDADO DE LEVANTAMENTO JUDICIAL ENCAMINHADO AO FINANCEIRO',
        'Manifestação A Impugnação',
        'Manifestação a Impugnação No Cumprimento De Sentença',
        'MLE LEVANTADO',
        'MLJ LEVANTADO',
        'PENHORA BB - NÃO OPORTUNIDADE',
        'PENHORA DE VALORES',
        'PENHORA DO BEM DEFERIDA - IMÓVEIS',
        'PENHORA DO BEM EFETIVADA - IMÓVEIS',
        'PENHORA DO BEM EFETIVADA - MÓVEIS',
        'PENHORA DO BEM NÃO EFETIVADA',
        'PENHORA DO BEM NÃO EFETIVADA – MÓVEIS',
        'PENHORA IMÓVEIS – AGUARDANDO CÁLCULOS ATUALIZADOS',
        'PENHORA IMÓVEIS – AGUARDANDO MATRICULA ATUALIZADA',
        'PENHORA IMÓVEIS – EXECUTADO SEM ADV CONSTITUÍDO',
        'PENHORA IMÓVEIS – IMPUGNAÇÃO PENDENTE DE JULGAMENTO',
        'PENHORA IMÓVEIS – INTIMAÇÃO DOS EXECUTADOS',
        'PENHORA IMÓVEIS - MATRICULA ATUALIZADA JUNTADA',
        'PENHORA IMÓVEIS - OUTRO ESTADO',
        'PENHORA IMÓVEIS - PETICIONAR DADOS BOLETO ARISP',
        'PENHORA MÓVEIS - AGUARDANDO EXPEDIÇÃO DO TERMO',
        'PENHORA MÓVEIS - AGUARDANDO MANDADO DE PENHORA E AVALIAÇÃO',
        'PENHORA MÓVEIS – EXECUTADO SEM ADV CONSTITUÍDO',
        'PENHORA MÓVEIS - INTIMAÇÃO DOS EXECUTADOS',
        'PENHORA ONLINE – AGUARDANDO TRANSFERÊNCIA VALORES',
        'PENHORA ONLINE - DEFERIDA',
        'PENHORA ONLINE – INTIMAÇÃO DOS EXECUTADOS',
        'PENHORA ONLINE - NEGATIVA',
        'PENHORA ONLINE - POSITIVA',
        'PENHORA ONLINE – VALORES IMPUGNADOS',
        'PENHORA ONLINE POSITIVA – TRANSFERÊNCIA',
        'PENHORA ONLINE POSITIVA - TRANSFERÊNCIA NÃO REALIZADA',
        'PENHORA ONLINE POSITIVA – VALORES DESBLOQUEADOS',
        'Penhora Qualificada',
        'PESQUISA COMPLETA DE BENS',
        'PETIÇÃO DE BLOQUEIO DE VEÍCULOS - RENAJUD',
        'PETIÇÃO DE HOMOLOGAÇÃO DA AVALIAÇÃO',
        'PETIÇÃO DE PENHORA DOS DIREITOS – BENS IMÓVEIS',
        'PETIÇÃO DE PENHORA DOS DIREITOS – BENS MÓVEIS',
        'PETIÇÃO REQUERENDO OFICIO SUSEP',
        'PETICAO REQUERENDO PESQUISA BACEN JUD E INFOJUD',
        'PETICAO REQUERENDO PESQUISA BACEN JUD E RENAJUD',
        'PETIÇÃO REQUERENDO PESQUISA INFOJUD',
        'PETICAO REQUERENDO PESQUISA RENAJUD E INFOJUD',
        'PETIÇÃO REQUERENDO REGISTRO DA PENHORA DE IMÓVEIS - ARISP',
        'PETICIONAMOS PELA AVALIAÇÃO DO BEM',
        'PETICIONAMOS PELA AVALIAÇÃO DOS BENS',
        'PETICIONAMOS PELA AVALIAÇÃO E PRACEAMENTO DOS BENS',
        'PETICIONAMOS PELA DESIGNAÇÃO DE HASTA',
        'PETICIONAMOS PELA DESIGNAÇÃO DE HASTA - IMÓVEIS',
        'PETICIONAMOS PELA DESIGNAÇÃO DE HASTA - VEÍCULOS',
        'PETICIONAMOS PELA DESIGNAÇÃO DE HASTA PUBLICA',
        'PETICIONAMOS PELA PENHORA DE BENS IMÓVEIS',
        'PETICIONAMOS PELA PENHORA DE BENS MÓVEIS',
        'PETICIONAMOS REQUERENDO A RESTRIÇÃO DO VEICULO',
        'PETICIONAR REQUERENDO AVALIAÇÃO PELO OJ',
        'PETICIONAR REQUERENDO NOMEAÇÃO DE PERITO AVALIADOR',
        'RECURSO DE APELAÇÃO',
        'Recurso Especial',
        'RENAJUD - NEGATIVO',
        'RENAJUD - POSITIVO',
        'RÉPLICA',
        'RESPOSTA SUBSIDIO - MLJ RECEBIDO',
        'RESPOSTA SUBSIDIO MLJ – 1ª ETAPA NEGATIVA BANCO RÉU',
        'RESPOSTA SUBSIDIO MLJ – 1ª ETAPA POSITIVA ACORDO',
        'RESPOSTA SUBSIDIO MLJ – 1ª ETAPA POSITIVA BANCO RÉU',
        'SENTENÇA',
        'SENTENÇA - 794,I DO CPC',
        'SENTENÇA - CONSOLIDAÇÃO DA POSSE',
        'SENTENÇA - PRESCRIÇÃO INTERCORRENTE',
        'SENTENÇA 924',
        'SENTENÇA ANULADA',
        'SENTENÇA BB- UNIDADE CAMPINAS',
        'SENTENÇA CONDENATÓRIA',
        'SENTENÇA DE EXTINÇÃO SEM JULGAMENTO DE MÉRITO',
        'SENTENÇA DE HOMOLOGAÇÃO DE ACORDO',
        'SENTENÇA DE HOMOLOGAÇÃO DE ACORDO - EXTINÇÃO',
        'SENTENÇA DE HOMOLOGAÇÃO DE ACORDO - SUSPENSÃO',
        'SENTENÇA DE JULGAMENTO ANTECIPADO PARCIAL DE MÉRITO - PEDIDO EXTINTO SEM RESOLUÇÃO DE MÉRITO',
        'SENTENÇA DE JULGAMENTO ANTECIPADO PARCIAL DE MÉRITO - PEDIDO PARCIALMENTE PROCEDENTE',
        'SENTENÇA EXTINÇÃO SEM MÉRITO',
        'SENTENÇA HABILITAÇÃO DE SUCESSORES',
        'SENTENÇA IMPROCEDENTE',
        'SENTENÇA IMPROCEDENTE - IMPUGNAÇÃO',
        'SENTENÇA IMPROCEDENTE - MÉRITO',
        'SENTENÇA IMPROCEDENTE DOS EMBARGOS',
        'SENTENÇA PARCIALMENTE PROCEDENTE',
        'SENTENÇA PARCIALMENTE PROCEDENTE - IMPUGNAÇÃO',
        'SENTENÇA PARCIALMENTE PROCEDENTE - MÉRITO',
        'SENTENÇA PARCIALMENTE PROCEDENTE - SEM ÔNUS',
        'SENTENÇA PROCEDENTE',
        'SENTENÇA PROCEDENTE - COM ÔNUS',
        'SENTENÇA PROCEDENTE - EMBARGOS',
        'SENTENÇA PROCEDENTE - IMPUGNAÇÃO',
        'SENTENÇA PROCEDENTE - MÉRITO',
        'SENTENÇA PROCEDENTE - SEM ÔNUS',
        'SOLICITAÇÃO DE AVALIAÇÃO DE IMÓVEL',
        'SUBSÍDIO - CONTA MLE NÃO RECEPCIONADA',
        'SUBSÍDIO - CONTA VINCULADA NÃO RECEPCIONADA',
        'SUBSÍDIO - RECEPÇÃO DE CONTA VINCULADA',
        'SUBSÍDIO - SOLICITAÇÃO DE CONTA MLE',
        'SUBSÍDIO - SOLICITAÇÃO DE CONTA VINCULADA',
        'SUBSÍDIO MLJ – 3ª ETAPA',
        'SUBSIDIO -RECEPÇÃO DE CONTA MLE',
        'SUCUMBÊNCIA PAGA',
        'SUSEP NEGATIVA',
        'SUSEP POSITIVA')
 ) anda_INDICIOS_CITACAO
     ON FP.PASTA = anda_INDICIOS_CITACAO.PASTA 
 AND anda_INDICIOS_CITACAO.rn = 1

-- Situação da Esteira de Encerramento (TRIARE)
LEFT JOIN (
    SELECT 
        PASTA, TAREFA, DATA_CRIACAO_TAREFA,
        ROW_NUMBER() OVER (PARTITION BY PASTA ORDER BY DATA_CRIACAO_TAREFA DESC) AS RT
    FROM JURIDICO.TRIARE_ENCERRAMENTO 
) TAR_TRIARE
    ON FP.PASTA = TAR_TRIARE.PASTA 
   AND TAR_TRIARE.RT = 1

-- Cálculo da Menor Data entre as Citações
CROSS APPLY (
    SELECT MIN(DT) AS MIN_DATA
    FROM (VALUES
         (anda_CITACAO_POSITIVA.DATA_ANDAMENTO),
         (anda_CITACAO_PARCIAL.DATA_ANDAMENTO),
         (anda_CITACAO_COMPARECIMENTO.DATA_ANDAMENTO)
    ) AS D(DT)
) AS MINDATECIT

-- Verificação Cruzada de Pendência de Citação
LEFT JOIN (
    SELECT 
        FP.PASTA,
        VAND.TIPO_ANDAMENTO,
        VAND.DATA_ANDAMENTO,
        CASE
            WHEN COMP.TIPO_COMPROMISSO IS NULL 
                 AND VAND.TIPO_ANDAMENTO IS NOT NULL 
            THEN 'PENDENTE DE CITAÇÃO'
            ELSE NULL
        END AS PENDENTE_CIT
    FROM JURIDICO.FICHAPROCESSUAL FP WITH (NOLOCK)
    INNER JOIN FICHABB FB WITH (NOLOCK)
         ON FB.PASTA = FP.PASTA
    LEFT JOIN JURIDICO.COMPROMISSOS_PENDENTES COMP WITH (NOLOCK)
         ON FP.PASTA = COMP.PASTA
         AND COMP.TIPO_COMPROMISSO IN (
             'INDICAR ENDEREÇO',
             'INDICAR ENDEREÇO - PESQUISA REALIZADA',
             'CITAÇÃO DE TODOS OS DEVEDORES / EDITAL',
             'CONFECCIONAR MINUTA DE EDITAL',
             'EDITAL - SOLICITAÇÃO DE COTAÇÕES DE PUBLICAÇÃO',
             'MANIFESTAR - CERTIDÃO DE OFICIAL DE JUSTIÇA',
             'ACOMPANHAMENTO DE ORÇAMENTO PUBLICAÇÃO DE EDITAL'
         )
    LEFT JOIN (
        SELECT 
            ANDA.PASTA,
            ANDA.TIPO_ANDAMENTO,
            ANDA.DATA_ANDAMENTO,
            ROW_NUMBER() OVER (
                PARTITION BY ANDA.PASTA 
                ORDER BY ANDA.DATA_ANDAMENTO DESC
            ) AS RK
        FROM JURIDICO.ANDAMENTOS ANDA WITH (NOLOCK)
        INNER JOIN FICHABB FB2
             ON ANDA.PASTA = FB2.PASTA
        WHERE ANDA.TIPO_ANDAMENTO IN (
             'CITAÇÃO NEGATIVA - NOVO ENDEREÇO INFORMANDO',
             'CITAÇÃO NEGATIVA - CITAÇÃO POR EDITAL REQUERIDA AO JUIZO',
             'CITAÇÃO NEGATIVA - PESQUISA DE ENDEREÇO',
             'PETIÇÃO DE INDICAÇÃO DE ENDEREÇO')
        AND NOT EXISTS (
            SELECT 1 
            FROM JURIDICO.ANDAMENTOS ANDA2 WITH(NOLOCK)
            WHERE ANDA.PASTA = ANDA2.PASTA
            AND ANDA2.TIPO_ANDAMENTO IN
            ('CITAÇÃO POSITIVA', 
            'CITAÇÃO PARCIAL', 
            'CITAÇÃO - COMPARECIMENTO ESPONTANEO')
         )
    ) AS VAND 
         ON FP.PASTA = VAND.PASTA 
         AND VAND.RK = 1
) AS CITPEN
     ON FP.PASTA = CITPEN.PASTA
