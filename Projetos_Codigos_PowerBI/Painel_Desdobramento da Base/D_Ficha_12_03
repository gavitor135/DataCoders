-- 1. Cria a tabela temporária com os andamentos relevantes
SELECT 
    ANDA.PASTA,
    ANDA.TIPO_ANDAMENTO,
    ANDA.DATA_ANDAMENTO,
    ANDA.HORA_ANDAMENTO
INTO #TempAndamentos
FROM JURIDICO.ANDAMENTOS ANDA WITH (NOLOCK)
WHERE ANDA.TIPO_ANDAMENTO IN (
    'IMP 023 - CITAÇÃO PARCIAL - PJ',
    'IMP 024 - CITAÇÃO PARCIAL - DSO',
    'IMP 024.1 - CITAÇÃO POSITIVA - PF',
    'IMP 024.2 - CITAÇÃO POSITIVA TOTAL DOS TITULARES - PF',
    'IMP 024.3 - CITAÇÃO PARCIAL DOS TITULARES - PF',
    'IMP 025 - CITAÇÃO  COMPARECIMENTO ESPONTANEO',
    'IMP 026 - CITAÇÃO POR EDITAL',
    'IMP 027 - CITAÇÃO POSITIVA TOTAL - PJ E DSO',
    'IMP 028 - CITAÇÃO  MANDADO EXPEDIDO',
    'IMP 029 - CITAÇÃO VIA WHATSAPP POSITIVA',
    'IMP 030 - CITAÇÃO VIA WHATSAPP PARCIAL - PJ',
    'IMP 031 - CITAÇÃO VIA WHATSAPP PARCIAL - DSO',
    'IMP 032 - MONITÓRIA - CONVERTIDA EM EXECUÇÃO',
    'IMP 033 - ORDINÁRIA - CONVERTIDA EM EXECUÇÃO',
    'IMP 012 - ARRESTO VALORES - PETICIONADO',
    'IMP 079 - TESE GRUPO ECONÔMICO - PETICIONADO',
    'IMP 080 - TESE GRUPO ECONÔMICO - DEFERIDO',
    'IMP 080.1 - TESE GRUPO ECONÔMICO - INDEFERIDO',
    'IMP 085 - TESE DESCONSIDERAÇÃO INVERSA DA PERSONALIDADE JURÍDICA - PETICIONADO',
    'IMP 086 - TESE DESCONSIDERAÇÃO INVERSA DA PERSONALIDADE JURÍDICA - DEFERIDO',
    'IMP 086.1 - TESE DESCONSIDERAÇÃO INVERSA DA PERSONALIDADE JURÍDICA - INDEFERIDO',
    'IMP 083 - TESE FRAUDE À EXECUÇÃO - PETICIONADO',
    'IMP 084 - TESE FRAUDE À EXECUÇÃO - DEFERIDO',
    'IMP 084.1 - TESE FRAUDE À EXECUÇÃO - INDEFERIDO',
    'IMP 076 - TESE DESVIO DE RECEBÍVEIS - PETICIONADO',
    'IMP 077 - TESE DESVIO DE RECEBÍVEIS - DEFERIDO',
    'IMP 077.1 - TESE DESVIO DE RECEBÍVEIS - INDEFERIDO',
    'IMP 070 - TESE PENHORA FATURAMENTO - PETICIONADO ',
    'IMP 071 - TESE PENHORA FATURAMENTO - DEFERIDO',
    'IMP 071.1 - TESE PENHORA FATURAMENTO - INDEFERIDO',
    'IMP 072 - TESE PENHORA FATURAMENTO - AJ NOMEADO',
    'IMP 072.1 - TESE PENHORA FATURAMENTO - DESCONSTITUÍDA',
    'IMP 073 - TESE PENHORA FATURAMENTO - VALORES DEPOSITADOS',
    'IMP 074 - TESE PENHORA FATURAMENTO - SOLICITADO EXPEDIÇÃO DE MLE',
    'IMP 075 - TESE PENHORA FATURAMENTO - REPASSE EFETUADO ',
    'IMP 081 - TESE SUCESSÃO EMPRESARIAL - PETICIONADO ',
    'IMP 082 - TESE SUCESSÃO EMPRESARIAL - DEFERIDO ',
    'IMP 082.1 - TESE SUCESSÃO EMPRESARIAL - INDEFERIDO',
    'IMP 087 - TESE FRAUDE CONTRA CREDORES - PETICIONADO',
    'IMP 088 - TESE FRAUDE CONTRA CREDORES - DEFERIDO',
    'IMP 088.1 - TESE FRAUDE CONTRA CREDORES - INDEFERIDO',
    'IMP 089 - TESE PEDIDO DE FALÊNCIA - PETICIONADO',
    'IMP 090 - TESE PEDIDO DE FALÊNCIA - DEFERIDO',
    'IMP 090.1 - TESE PEDIDO DE FALÊNCIA - INDEFERIDO',
    'IMP 091 - TESE APREENSÃO DE PASSAPORTE - PETICIONADO',
    'IMP 092 - TESE APREENSÃO DE PASSAPORTE - DEFERIDO',
    'IMP 092.1 - TESE APREENSÃO DE PASSAPORTE - INDEFERIDO',
    'IMP 093- TESE BLOQUEIO DE CNH - PETICIONADO',
    'IMP 094 - TESE BLOQUEIO DE CNH - DEFERIDO',
    'IMP 094.1 - TESE BLOQUEIO DE CNH - INDEFERIDO',
    'IMP 095- TESE BLOQUEIO PENHORA DE MARCA E PATENTE - PETICIONADO',
    'IMP 096 - TESE BLOQUEIO PENHORA DE MARCA E PATENTE - DEFERIDO',
    'IMP 096.1 - TESE BLOQUEIO PENHORA DE MARCA E PATENTE - INDEFERIDO',
    'IMP 080 - TESE GRUPO ECONÔMICO - DEFERIDO',
    'IMP 082 - TESE SUCESSÃO EMPRESARIAL - DEFERIDO',
    'IMP 075 - TESE PENHORA FATURAMENTO - REPASSE EFETUADO',
    'IMP 071.1 - TESE PENHORA FATURAMENTO - INDEFERIDO',
    'IMP 046 - PENHORA VALORES - POSITIVO',
    'IMP 100 - PESQUISA ARISP POSITIVA',
    'PESQUISA COMPLETA DE BENS - TESE DIFERENCIADA - POSITIVA',
    'IMP 046.2 - PENHORA VALORES - NEGATIVA',
    'IMP 101 - PESQUISA ARISP NEGATIVA',
    'PESQUISA COMPLETA DE BENS - TESE DIFERENCIADA - NEGATIVA',
    'IMP 037 - PENHORA IMÓVEIS - DEFERIDO',
    'IMP 041 - PENHORA MÓVEIS - DEFERIDO',
    'IMP 045 - PENHORA VALORES - DEFERIDO',
    'IMP 047 - PENHORA VALORES - SOLICITADO EXPEDIÇÃO DE MLE',
    'IMP 048 - PENHORA VALORES - REPASSE EFETUADO',
    'IMP 050 - PENHORA NO ROSTO DOS AUTOS - DEFERIDO',
    'IMP 054 - PENHORA COTAS SOCIAIS - DEFERIDA',
    'IMP 039.1 - PENHORA IMÓVEIS - DESCONSTITUÍDA',
    'IMP 042.1 - PENHORA MÓVEIS - DESCONSTITUÍDA ',
    'IMP 004 - ARRESTO IMÓVEIS - REGISTRADO',
    'IMP 039 - PENHORA IMÓVEIS - REGISTRADO ',
    'IMP 042 - PENHORA MÓVEIS - REGISTRADO ',
    'IMP 055- PENHORA COTAS SOCIAIS - REGISTRADO ',
    'IMP 021 - AVERBAÇÃO PREMONITÓRIA 828 - REGISTRADA',
    'IMP 044 - PENHORA VALORES - PETICIONADO',
    'IMP 013 - ARRESTO VALORES - DEFERIDO',
    'IMP 014 - ARRESTO VALORES - POSITIVO',
    'IMP 036 - PENHORA IMÓVEIS - PETICIONADO',
    'IMP 039 - PENHORA IMÓVEIS - REGISTRADO',
    'IMP 001 - ARRESTO IMÓVEIS - PETICIONADO',
    'IMP 002 - ARRESTO IMÓVEIS - DEFERIDO',
    'IMP 040 - PENHORA MÓVEIS - PETICIONADO',
    'IMP 042 - PENHORA MÓVEIS - REGISTRADO',
    'IMP 007 - ARRESTO MÓVEIS - PETICIONADO',
    'IMP 008 - ARRESTO MÓVEIS - DEFERIDO',
    'IMP 009 - ARRESTO MÓVEIS - REGISTRADO',
    'IMP 070 - TESE PENHORA FATURAMENTO - PETICIONADO',
    'IMP 072.1 - TESE PENHORA FATURAMENTO - DESCONSTITUÍDA ',
    'IMP 073 - TESE PENHORA FATURAMENTO - VALORES DEPOSITADOS ',
    'IMP 053 - PENHORA COTAS SOCIAIS - PETICIONADO',
    'IMP 049 - PENHORA NO ROSTO DOS AUTOS - PETICIONADO',
    'IMP 037.2 - PENHORA DIREITOS AQUISITIVOS DO IMÓVEL - DEFERIDO',
    'IMP 054 - PENHORA COTAS SOCIAIS - DEFERIDO',
    'IMP 055- PENHORA COTAS SOCIAIS - REGISTRADO',
    'IMP 021 - AVERBAÇÃO PREMONITÓRIA 828 - REGISTRADA',
    'IMP 059 - LEILÃO MÓVEIS - DEFERIDO; IMP 066 - HASTA IMÓVEIS - DEFERIDO',
    'IMP 015 - ARRESTO VALORES - SOLICITADO EXPEDIÇÃO DE MLE',
    'IMP 047 - PENHORA VALORES - SOLICITADO EXPEDIÇÃO DE MLE'
);
CREATE INDEX idx_temp_andamentos ON #TempAndamentos(PASTA);

;WITH FICHAVAREJO AS (
    SELECT
        FP.PASTA,
        FP.PRODUTO,
        FP.CARTEIRA,
        FP.ASSUNTO,
        FP.STATUS_PASTA,
        FP.TIPO_ACAO,
        FP.BJ,
        FP.PROCESSO,
        FP.PARTE_ADVERSA,
        FP.OUTROS,
        FP.VALOR_CAUSA
    FROM JURIDICO.FICHAPROCESSUAL FP WITH (NOLOCK)
    WHERE FP.PRODUTO = 'ITAÚ - COBRANÇA VAREJO'
      AND FP.STATUS_PASTA = 'ATIVO'
),
AcordoRecente AS (
    SELECT 
        contr.nkPasta,
        acord.statusAcordo AS STATUS_ACORDO,
        acord.nkstatusAcordo AS NK_STATUS_ACORDO,
        acord.dataPrimeiroVencimento,
        ROW_NUMBER() OVER (PARTITION BY contr.NKPASTA ORDER BY acord.dataPrimeiroVencimento DESC, acord.nkstatusAcordo DESC) AS rk,
        CASE 
            WHEN acord.nkstatusAcordo IN (1, 3) THEN 'MINUTA ENVIADA'
            WHEN acord.nkstatusAcordo IN (5, 6) THEN 'ACORDO PAGO'
            WHEN acord.nkstatusAcordo IN (2, 7, 9) THEN 'CANCELADO'
            ELSE 'OUTROS' 
        END AS STATUS_GERAL
    FROM 
        negocial.COB_clienteEvento AS evc WITH (NOLOCK)
        LEFT JOIN negocial.COB_Acordo AS acord WITH (NOLOCK) ON evc.nkClienteEvento = acord.nkAcordo
        LEFT JOIN negocial.COB_Cliente AS cli WITH (NOLOCK) ON evc.nkCliente = cli.nkCliente
        LEFT JOIN negocial.COB_Contrato AS contr WITH (NOLOCK) ON cli.nkCliente = contr.nkCliente
        INNER JOIN FICHAVAREJO AS FP ON contr.nkPasta = FP.PASTA
),
CTE_VALOR_PENHORA AS (
    SELECT 
        FP.PASTA,
        FP.VALOR_CAUSA,
        COALESCE(PENIMO.VALOR_DE_ARREMATACAO_PENHORA_IMOVEIS, 0) +
        COALESCE(PENMLE.VALOR_NOMINAL_DO_DEPOSITO_PENHORA_MLE, 0) +
        COALESCE(PENMLJ.VALOR_LEVANTADO_PENHORA_MLJ, 0) +
        COALESCE(PENOUTROS.VALOR_LEVANTADO_PELO_BANCO_PENHORA_OUTROS, 0) +
        COALESCE(PENVEICULOS.VALOR_DE_ARREMATACAO_PENHORA_VEICULO, 0) AS VALOR_DA_PENHORA,
        COALESCE(PENMLE.VALOR_NOMINAL_DO_DEPOSITO_PENHORA_MLE, 0) +
        COALESCE(PENMLJ.VALOR_LEVANTADO_PENHORA_MLJ, 0) AS VALOR_DA_PENHORA_FATURAMENTO
    FROM FICHAVAREJO FP
    LEFT JOIN JURIDICO.PENHORA_IMOVEIS PENIMO WITH (NOLOCK) ON FP.PASTA = PENIMO.PASTA 
    LEFT JOIN JURIDICO.PENHORA_MLE PENMLE WITH (NOLOCK) ON FP.PASTA = PENMLE.PASTA 
    LEFT JOIN JURIDICO.PENHORA_MLJ PENMLJ WITH (NOLOCK) ON FP.PASTA = PENMLJ.PASTA
    LEFT JOIN JURIDICO.PENHORA_OUTROS PENOUTROS WITH (NOLOCK) ON FP.PASTA = PENOUTROS.PASTA
    LEFT JOIN JURIDICO.PENHORA_VEICULOS PENVEICULOS WITH (NOLOCK) ON FP.PASTA = PENVEICULOS.PASTA
),
CTE_VALOR_PENHORA_FATURAMENTO AS (
    SELECT 
        FP.PASTA,
        FP.VALOR_CAUSA,
        COALESCE(PENMLE.VALOR_NOMINAL_DO_DEPOSITO_PENHORA_MLE, 0) +
        COALESCE(PENMLJ.VALOR_LEVANTADO_PENHORA_MLJ, 0) AS VALOR_DA_PENHORA_FATURAMENTO
    FROM FICHAVAREJO FP
    LEFT JOIN JURIDICO.PENHORA_MLE PENMLE WITH (NOLOCK) ON FP.PASTA = PENMLE.PASTA 
    LEFT JOIN JURIDICO.PENHORA_MLJ PENMLJ WITH (NOLOCK) ON FP.PASTA = PENMLJ.PASTA
    LEFT JOIN #TempAndamentos TA WITH (NOLOCK) 
         ON FP.PASTA = TA.PASTA 
        AND TA.TIPO_ANDAMENTO IN (
            'IMP 073 - TESE PENHORA FATURAMENTO - VALORES DEPOSITADOS',
            'IMP 074 - TESE PENHORA FATURAMENTO - SOLICITADO EXPEDIÇÃO DE MLE',
            'IMP 075 - TESE PENHORA FATURAMENTO - REPASSE EFETUADO'
        )
),
CTE_CONTAGEM_TENTATIVA_CIT AS ( 
    SELECT 
        Y.PASTA,
        COUNT(*) AS TOTAL_CIT
    FROM JURIDICO.ANDAMENTOS Y WITH (NOLOCK)
    INNER JOIN FICHAVAREJO FP ON Y.PASTA = FP.PASTA 
         AND Y.TIPO_ANDAMENTO = 'IMP 028 - CITAÇÃO  MANDADO EXPEDIDO'
    GROUP BY Y.PASTA
)
SELECT
    FP.PASTA,
    FP.BJ,
    FP.PARTE_ADVERSA,
    'PAULO ROBERTO JOAQUIM DOS REIS' AS ESCOB,
    CASE
        WHEN ANDA_CITACAO.TIPO_ANDAMENTO IN (
            'IMP 027 - CITAÇÃO POSITIVA TOTAL - PJ E DSO',
            'IMP 024.2 - CITAÇÃO POSITIVA TOTAL DOS TITULARES - PF',
            'IMP 026 - CITAÇÃO POR EDITAL',
            'IMP 029 - CITAÇÃO VIA WHATSAPP POSITIVA',
            'IMP 025 - CITAÇÃO  COMPARECIMENTO ESPONTANEO'
        ) THEN 'TOTAL'
        WHEN ANDA_CITACAO.TIPO_ANDAMENTO IN (
            'IMP 023 - CITAÇÃO PARCIAL - PJ',
            'IMP 024 - CITAÇÃO PARCIAL - DSO',
            'IMP 030 - CITAÇÃO VIA WHATSAPP PARCIAL - PJ',
            'IMP 031 - CITAÇÃO VIA WHATSAPP PARCIAL - DSO'
        ) THEN 'PARCIAL'
        WHEN ANDA_CITACAO.TIPO_ANDAMENTO = 'IMP 022 - CITAÇÃO NEGATIVA TOTAL - PJ E DSO'
            THEN 'NEGATIVA'
        ELSE 'PENDENTE'
    END AS CITACAO,
    (SELECT COUNT(*) 
     FROM JURIDICO.FICHAPROCESSUAL X WITH (NOLOCK)
     WHERE X.PASTA = FP.PASTA 
       AND X.PARTE_ADVERSA IS NOT NULL) AS QUANTIDADE_DE_EXECUTADOS,
    CASE
        WHEN ANDA_CITACAO.TIPO_ANDAMENTO = 'IMP 026 - CITAÇÃO POR EDITAL' THEN 'EDITAL'
        WHEN ANDA_CITACAO.TIPO_ANDAMENTO = 'IMP 029 - CITAÇÃO VIA WHATSAPP POSITIVA' THEN 'WHATSAPP'
        WHEN ANDA_CITACAO.TIPO_ANDAMENTO IS NOT NULL THEN 'AR'
        ELSE 'OUTROS'
    END AS TENTATIVA_DE_CITACAO,
    (SELECT COUNT(*)
     FROM JURIDICO.ANDAMENTOS Y WITH (NOLOCK)
     WHERE Y.PASTA = FP.PASTA 
       AND Y.TIPO_ANDAMENTO = 'IMP 028 - CITAÇÃO  MANDADO EXPEDIDO') AS QUANTIDADE_DE_TENTATIVAS,
    CASE
        WHEN FP.OUTROS IS NOT NULL THEN 'SIM'
        ELSE 'NÃO'
    END AS [POSSUI_ADV_CONSTITUIDO?],
    -- A coluna TESE_AJUIZADA_ORIGINAL vem da junção com ANDA_TESE:
    ANDA_TESE.TIPO_ANDAMENTO AS TESE_AJUIZADA_ORIGINAL,
    -- CROSS APPLY para calcular TESE_AJUIZADA uma única vez:
    Calc.TESE_AJUIZADA_Calc AS TESE_AJUIZADA,
    CASE
        WHEN ANDA_TESE_DEFERIDA.TIPO_ANDAMENTO IN (
            'IMP 080 - TESE GRUPO ECONÔMICO - DEFERIDO',
            'IMP 086 - TESE DESCONSIDERAÇÃO INVERSA DA PERSONALIDADE JURÍDICA - DEFERIDO',
            'IMP 084 - TESE FRAUDE À EXECUÇÃO - DEFERIDO',
            'IMP 077 - TESE DESVIO DE RECEBÍVEIS - DEFERIDO',
            'IMP 071 - TESE PENHORA FATURAMENTO - DEFERIDO',
            'IMP 082 - TESE SUCESSÃO EMPRESARIAL - DEFERIDO',
            'IMP 088 - TESE FRAUDE CONTRA CREDORES - DEFERIDO',
            'IMP 090 - TESE PEDIDO DE FALÊNCIA - DEFERIDO',
            'IMP 092 - TESE APREENSÃO DE PASSAPORTE - DEFERIDO',
            'IMP 094 - TESE BLOQUEIO DE CNH - DEFERIDO',
            'IMP 096 - TESE BLOQUEIO PENHORA DE MARCA E PATENTE - DEFERIDO'
        ) THEN 'PROVIDO'
        WHEN ANDA_TESE_DEFERIDA.TIPO_ANDAMENTO IN (
            'IMP 080.1 - TESE GRUPO ECONÔMICO - INDEFERIDO',
            'IMP 086.1 - TESE DESCONSIDERAÇÃO INVERSA DA PERSONALIDADE JURÍDICA - INDEFERIDO',
            'IMP 084.1 - TESE FRAUDE À EXECUÇÃO - INDEFERIDO',
            'IMP 077.1 - TESE DESVIO DE RECEBÍVEIS - INDEFERIDO',
            'IMP 071.1 - TESE PENHORA FATURAMENTO - INDEFERIDO',
            'IMP 082.1 - TESE SUCESSÃO EMPRESARIAL - INDEFERIDO',
            'IMP 088.1 - TESE FRAUDE CONTRA CREDORES - INDEFERIDO',
            'IMP 090.1 - TESE PEDIDO DE FALÊNCIA - INDEFERIDO',
            'IMP 092.1 - TESE APREENSÃO DE PASSAPORTE - INDEFERIDO',
            'IMP 094.1 - TESE BLOQUEIO DE CNH - INDEFERIDO',
            'IMP 096.1 - TESE BLOQUEIO PENHORA DE MARCA E PATENTE - INDEFERIDO'
        ) THEN 'IMPROVIDO'
        WHEN acorven.STATUS_GERAL IN ('MINUTA ENVIADA','ACORDO PAGO') THEN 'ACORDO'
        WHEN FP.TIPO_ACAO = 'MONITÓRIA' 
             AND ANDA_TESE_COMPLEMENTAR_MONITORIA.TIPO_ANDAMENTO = 'IMP 032 - MONITÓRIA - CONVERTIDA EM EXECUÇÃO'
             THEN 'PROVIDO'
        WHEN FP.TIPO_ACAO = 'COBRANÇA' 
             AND ANDA_TESE_COMPLEMENTAR_ORDINARIA.TIPO_ANDAMENTO = 'IMP 033 - ORDINÁRIA - CONVERTIDA EM EXECUÇÃO'
             THEN 'PROVIDO'
        WHEN Calc.TESE_AJUIZADA_Calc <> 'EXECUÇÃO PURA' THEN 'AGUARDANDO RESULTADO DA MATÉRIA'
        ELSE 'OUTROS'
    END AS RESULTADO_DA_MATERIA,
    CASE
        WHEN ANDA_TESE_FATURAMENTO.TIPO_ANDAMENTO IS NOT NULL THEN 'SIM'
        ELSE 'NÃO'
    END AS PENHORA_DE_FATURAMENTO,
    CASE 
        WHEN ANDA_TESE_FATURAMENTO.TIPO_ANDAMENTO IN (
            'IMP 071 - TESE PENHORA FATURAMENTO - DEFERIDO',
            'IMP 072 - TESE PENHORA FATURAMENTO - AJ NOMEADO',
            'IMP 073 - TESE PENHORA FATURAMENTO - VALORES DEPOSITADOS',
            'IMP 074 - TESE PENHORA FATURAMENTO - SOLICITADO EXPEDIÇÃO DE MLE',
            'IMP 075 - TESE PENHORA FATURAMENTO - REPASSE EFETUADO'
        ) THEN 'PROVIDO'
        WHEN ANDA_TESE_FATURAMENTO.TIPO_ANDAMENTO = 'IMP 071.1 - TESE PENHORA FATURAMENTO - INDEFERIDO' THEN 'IMPROVIDO'
        WHEN acorven.STATUS_GERAL IN ('MINUTA ENVIADA','ACORDO PAGO') THEN 'ACORDO'
        WHEN (CASE WHEN ANDA_TESE_FATURAMENTO.TIPO_ANDAMENTO IS NOT NULL THEN 'SIM' ELSE 'NÃO' END) = 'AGUARDANDO RESULTADO DA PENHORA DE FATURAMENTO' THEN 'N/A'
        ELSE 'N/A'
    END AS RESULTADO_PENHORA_FATURAMENTO,
    VAL_PENHORA.VALOR_DA_PENHORA_FATURAMENTO,
    CASE 
        WHEN VAL_PENHORA.VALOR_DA_PENHORA >= FP.VALOR_CAUSA THEN 'SIM'
        ELSE 'NÃO'
    END AS VALOR_E_SUFICIENTE_PARA_QUITAR_A_DIVIDA,
    CASE
        WHEN ANDA_TIPO_CONSTRICAO.TIPO_ANDAMENTO IN (
            'IMP 001 - ARRESTO IMÓVEIS - PETICIONADO',
            'IMP 007 - ARRESTO MÓVEIS - PETICIONADO',
            'IMP 012 - ARRESTO VALORES - PETICIONADO',
            'IMP 036 - PENHORA IMÓVEIS - PETICIONADO',
            'IMP 040 - PENHORA MÓVEIS - PETICIONADO',
            'IMP 044 - PENHORA VALORES - PETICIONADO',
            'IMP 049 - PENHORA NO ROSTO DOS AUTOS - PETICIONADO',
            'IMP 053 - PENHORA COTAS SOCIAIS - PETICIONADO'
        ) THEN 'REQUERIDA'
        WHEN ANDA_TIPO_CONSTRICAO.TIPO_ANDAMENTO IN (
            'IMP 002 - ARRESTO IMÓVEIS - DEFERIDO',
            'IMP 008 - ARRESTO MÓVEIS - DEFERIDO',
            'IMP 013 - ARRESTO VALORES - DEFERIDO',
            'IMP 037 - PENHORA IMÓVEIS - DEFERIDO',
            'IMP 041 - PENHORA MÓVEIS - DEFERIDO',
            'IMP 045 - PENHORA VALORES - DEFERIDO',
            'IMP 050 - PENHORA NO ROSTO DOS AUTOS - DEFERIDO',
            'IMP 054 - PENHORA COTAS SOCIAIS - DEFERIDA'
        ) THEN 'DEFERIDA'
        WHEN ANDA_TIPO_CONSTRICAO.TIPO_ANDAMENTO IN (
            'IMP 004 - ARRESTO IMÓVEIS - REGISTRADO',
            'IMP 039 - PENHORA IMÓVEIS - REGISTRADO',
            'IMP 042 - PENHORA MÓVEIS - REGISTRADO',
            'IMP 055- PENHORA COTAS SOCIAIS - REGISTRADO',
            'IMP 021 - AVERBAÇÃO PREMONITÓRIA 828 - REGISTRADA'
        ) THEN 'REGISTRADA'
        WHEN ANDA_TIPO_CONSTRICAO.TIPO_ANDAMENTO IN (
            'IMP 059 - LEILÃO MÓVEIS - DEFERIDO',
            'IMP 066 - HASTA IMÓVEIS - DEFERIDO'
        ) THEN 'AG.LEILÃO'
        WHEN ANDA_TIPO_CONSTRICAO.TIPO_ANDAMENTO IN (
            'IMP 015 - ARRESTO VALORES - SOLICITADO EXPEDIÇÃO DE MLE',
            'IMP 047 - PENHORA VALORES - SOLICITADO EXPEDIÇÃO DE MLE'
        ) THEN 'AG.MLJ'
        WHEN ANDA_TIPO_CONSTRICAO.TIPO_ANDAMENTO IN (
            'IMP 016 - ARRESTO VALORES - REPASSE EFETUADO',
            'IMP 048 - PENHORA VALORES - REPASSE EFETUADO',
            'IMP 052 - PENHORA NO ROSTO DOS AUTOS - REPASSE EFETUADO',
            'IMP 061 - LEILÃO MÓVEIS - POSITIVO - REPASSE DE VALORES',
            'IMP 068 - HASTA IMÓVEIS - POSITIVO - REPASSE DE VALORES'
        ) THEN 'PRESTAÇÃO DE CONTAS'
        ELSE 'N/A'
    END AS QUAL_A_FASE_DA_CONSTRIÇÃO,
    acorven.STATUS_GERAL
FROM FICHAVAREJO FP WITH (NOLOCK)
LEFT JOIN (
    SELECT 
        ANDA.PASTA,
        ANDA.TIPO_ANDAMENTO,
        ANDA.DATA_ANDAMENTO,
        ROW_NUMBER() OVER (
            PARTITION BY ANDA.PASTA 
            ORDER BY ANDA.DATA_ANDAMENTO DESC, ANDA.HORA_ANDAMENTO DESC
        ) AS RK
    FROM #TempAndamentos ANDA WITH (NOLOCK)
    INNER JOIN FICHAVAREJO FP2 WITH (NOLOCK) ON ANDA.PASTA = FP2.PASTA
    WHERE ANDA.TIPO_ANDAMENTO IN (
        'IMP 023 - CITAÇÃO PARCIAL - PJ',
        'IMP 024 - CITAÇÃO PARCIAL - DSO',
        'IMP 024.1 - CITAÇÃO POSITIVA - PF',
        'IMP 024.2 - CITAÇÃO POSITIVA TOTAL DOS TITULARES - PF',
        'IMP 024.3 - CITAÇÃO PARCIAL DOS TITULARES - PF',
        'IMP 025 - CITAÇÃO  COMPARECIMENTO ESPONTANEO',
        'IMP 026 - CITAÇÃO POR EDITAL',
        'IMP 027 - CITAÇÃO POSITIVA TOTAL - PJ E DSO',
        'IMP 028 - CITAÇÃO  MANDADO EXPEDIDO',
        'IMP 029 - CITAÇÃO VIA WHATSAPP POSITIVA',
        'IMP 030 - CITAÇÃO VIA WHATSAPP PARCIAL - PJ',
        'IMP 031 - CITAÇÃO VIA WHATSAPP PARCIAL - DSO'
    )
) AS ANDA_CITACAO
    ON FP.PASTA = ANDA_CITACAO.PASTA 
   AND ANDA_CITACAO.RK = 1
LEFT JOIN (
    SELECT 
        ANDA.PASTA,
        ANDA.TIPO_ANDAMENTO,
        ANDA.DATA_ANDAMENTO,
        ROW_NUMBER() OVER (
            PARTITION BY ANDA.PASTA 
            ORDER BY ANDA.DATA_ANDAMENTO DESC, ANDA.HORA_ANDAMENTO DESC
        ) AS RK
    FROM #TempAndamentos ANDA WITH (NOLOCK)
    INNER JOIN FICHAVAREJO FP3 WITH (NOLOCK) ON ANDA.PASTA = FP3.PASTA
    WHERE ANDA.TIPO_ANDAMENTO IN (
        'IMP 012 - ARRESTO VALORES - PETICIONADO',
        'IMP 079 - TESE GRUPO ECONÔMICO - PETICIONADO',
        'IMP 080 - TESE GRUPO ECONÔMICO - DEFERIDO',
        'IMP 080.1 - TESE GRUPO ECONÔMICO - INDEFERIDO',
        'IMP 085 - TESE DESCONSIDERAÇÃO INVERSA DA PERSONALIDADE JURÍDICA - PETICIONADO',
        'IMP 086 - TESE DESCONSIDERAÇÃO INVERSA DA PERSONALIDADE JURÍDICA - DEFERIDO',
        'IMP 086.1 - TESE DESCONSIDERAÇÃO INVERSA DA PERSONALIDADE JURÍDICA - INDEFERIDO',
        'IMP 083 - TESE FRAUDE À EXECUÇÃO - PETICIONADO',
        'IMP 084 - TESE FRAUDE À EXECUÇÃO - DEFERIDO',
        'IMP 084.1 - TESE FRAUDE À EXECUÇÃO - INDEFERIDO',
        'IMP 076 - TESE DESVIO DE RECEBÍVEIS - PETICIONADO',
        'IMP 077 - TESE DESVIO DE RECEBÍVEIS - DEFERIDO',
        'IMP 077.1 - TESE DESVIO DE RECEBÍVEIS - INDEFERIDO',
        'IMP 070 - TESE PENHORA FATURAMENTO - PETICIONADO ',
        'IMP 071 - TESE PENHORA FATURAMENTO - DEFERIDO',
        'IMP 071.1 - TESE PENHORA FATURAMENTO - INDEFERIDO',
        'IMP 072 - TESE PENHORA FATURAMENTO - AJ NOMEADO',
        'IMP 072.1 - TESE PENHORA FATURAMENTO - DESCONSTITUÍDA',
        'IMP 073 - TESE PENHORA FATURAMENTO - VALORES DEPOSITADOS',
        'IMP 074 - TESE PENHORA FATURAMENTO - SOLICITADO EXPEDIÇÃO DE MLE',
        'IMP 075 - TESE PENHORA FATURAMENTO - REPASSE EFETUADO ',
        'IMP 081 - TESE SUCESSÃO EMPRESARIAL - PETICIONADO ',
        'IMP 082 - TESE SUCESSÃO EMPRESARIAL - DEFERIDO ',
        'IMP 082.1 - TESE SUCESSÃO EMPRESARIAL - INDEFERIDO',
        'IMP 087 - TESE FRAUDE CONTRA CREDORES - PETICIONADO',
        'IMP 088 - TESE FRAUDE CONTRA CREDORES - DEFERIDO',
        'IMP 088.1 - TESE FRAUDE CONTRA CREDORES - INDEFERIDO',
        'IMP 089 - TESE PEDIDO DE FALÊNCIA - PETICIONADO',
        'IMP 090 - TESE PEDIDO DE FALÊNCIA - DEFERIDO',
        'IMP 090.1 - TESE PEDIDO DE FALÊNCIA - INDEFERIDO',
        'IMP 091 - TESE APREENSÃO DE PASSAPORTE - PETICIONADO',
        'IMP 092 - TESE APREENSÃO DE PASSAPORTE - DEFERIDO',
        'IMP 092.1 - TESE APREENSÃO DE PASSAPORTE - INDEFERIDO',
        'IMP 093- TESE BLOQUEIO DE CNH - PETICIONADO',
        'IMP 094 - TESE BLOQUEIO DE CNH - DEFERIDO',
        'IMP 094.1 - TESE BLOQUEIO DE CNH - INDEFERIDO',
        'IMP 095- TESE BLOQUEIO PENHORA DE MARCA E PATENTE - PETICIONADO',
        'IMP 096 - TESE BLOQUEIO PENHORA DE MARCA E PATENTE - DEFERIDO',
        'IMP 096.1 - TESE BLOQUEIO PENHORA DE MARCA E PATENTE - INDEFERIDO'
    )
) AS ANDA_TESE
    ON FP.PASTA = ANDA_TESE.PASTA 
   AND ANDA_TESE.RK = 1

-- Junção para trazer o andamento de Teses Deferidas(mais recente)
LEFT JOIN (
    SELECT 
        ANDA.PASTA,
        ANDA.TIPO_ANDAMENTO,
        ANDA.DATA_ANDAMENTO,
        ROW_NUMBER() OVER (
            PARTITION BY ANDA.PASTA 
            ORDER BY ANDA.DATA_ANDAMENTO DESC, ANDA.HORA_ANDAMENTO DESC
        ) AS RK
    FROM #TempAndamentos ANDA WITH (NOLOCK)
    INNER JOIN FICHAVAREJO FP4 WITH (NOLOCK) ON ANDA.PASTA = FP4.PASTA
    WHERE ANDA.TIPO_ANDAMENTO IN (
        'IMP 080 - TESE GRUPO ECONÔMICO - DEFERIDO',
        'IMP 086 - TESE DESCONSIDERAÇÃO INVERSA DA PERSONALIDADE JURÍDICA - DEFERIDO',
        'IMP 084 - TESE FRAUDE À EXECUÇÃO - DEFERIDO',
        'IMP 077 - TESE DESVIO DE RECEBÍVEIS - DEFERIDO',
        'IMP 071 - TESE PENHORA FATURAMENTO - DEFERIDO',
        'IMP 082 - TESE SUCESSÃO EMPRESARIAL - DEFERIDO',
        'IMP 088 - TESE FRAUDE CONTRA CREDORES - DEFERIDO',
        'IMP 090 - TESE PEDIDO DE FALÊNCIA - DEFERIDO',
        'IMP 092 - TESE APREENSÃO DE PASSAPORTE - DEFERIDO',
        'IMP 094 - TESE BLOQUEIO DE CNH - DEFERIDO',
        'IMP 096 - TESE BLOQUEIO PENHORA DE MARCA E PATENTE - DEFERIDO',
        'IMP 080.1 - TESE GRUPO ECONÔMICO - INDEFERIDO',
        'IMP 086.1 - TESE DESCONSIDERAÇÃO INVERSA DA PERSONALIDADE JURÍDICA - INDEFERIDO',
        'IMP 084.1 - TESE FRAUDE À EXECUÇÃO - INDEFERIDO',
        'IMP 077.1 - TESE DESVIO DE RECEBÍVEIS - INDEFERIDO',
        'IMP 071.1 - TESE PENHORA FATURAMENTO - INDEFERIDO',
        'IMP 082.1 - TESE SUCESSÃO EMPRESARIAL - INDEFERIDO',
        'IMP 088.1 - TESE FRAUDE CONTRA CREDORES - INDEFERIDO',
        'IMP 090.1 - TESE PEDIDO DE FALÊNCIA - INDEFERIDO',
        'IMP 092.1 - TESE APREENSÃO DE PASSAPORTE - INDEFERIDO',
        'IMP 094.1 - TESE BLOQUEIO DE CNH - INDEFERIDO',
        'IMP 096.1 - TESE BLOQUEIO PENHORA DE MARCA E PATENTE - INDEFERIDO'
    )
) AS ANDA_TESE_DEFERIDA
    ON FP.PASTA = ANDA_TESE_DEFERIDA.PASTA 
   AND ANDA_TESE_DEFERIDA.RK = 1

LEFT JOIN (
    SELECT 
        ANDA.PASTA,
        ANDA.TIPO_ANDAMENTO,
        ANDA.DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY ANDA.PASTA ORDER BY ANDA.DATA_ANDAMENTO DESC, ANDA.HORA_ANDAMENTO DESC) AS RK
    FROM #TempAndamentos ANDA WITH (NOLOCK)
    INNER JOIN FICHAVAREJO FP4 WITH (NOLOCK) ON ANDA.PASTA = FP4.PASTA
    WHERE ANDA.TIPO_ANDAMENTO = 'IMP 032 - MONITÓRIA - CONVERTIDA EM EXECUÇÃO'
) AS ANDA_TESE_COMPLEMENTAR_MONITORIA
    ON FP.PASTA = ANDA_TESE_COMPLEMENTAR_MONITORIA.PASTA 
   AND ANDA_TESE_COMPLEMENTAR_MONITORIA.RK = 1
LEFT JOIN (
    SELECT 
        ANDA.PASTA,
        ANDA.TIPO_ANDAMENTO,
        ANDA.DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY ANDA.PASTA ORDER BY ANDA.DATA_ANDAMENTO DESC, ANDA.HORA_ANDAMENTO DESC) AS RK
    FROM #TempAndamentos ANDA WITH (NOLOCK)
    INNER JOIN FICHAVAREJO FP4 WITH (NOLOCK) ON ANDA.PASTA = FP4.PASTA
    WHERE ANDA.TIPO_ANDAMENTO = 'IMP 033 - ORDINÁRIA - CONVERTIDA EM EXECUÇÃO'
) AS ANDA_TESE_COMPLEMENTAR_ORDINARIA
    ON FP.PASTA = ANDA_TESE_COMPLEMENTAR_ORDINARIA.PASTA 
   AND ANDA_TESE_COMPLEMENTAR_ORDINARIA.RK = 1
LEFT JOIN (
    SELECT 
        ANDA.PASTA,
        ANDA.TIPO_ANDAMENTO,
        ANDA.DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY ANDA.PASTA ORDER BY ANDA.DATA_ANDAMENTO DESC, ANDA.HORA_ANDAMENTO DESC) AS RK
    FROM #TempAndamentos ANDA WITH (NOLOCK)
    INNER JOIN FICHAVAREJO FP5 WITH (NOLOCK) ON ANDA.PASTA = FP5.PASTA
    WHERE ANDA.TIPO_ANDAMENTO IN (
         'IMP 070 - TESE PENHORA FATURAMENTO - PETICIONADO',
         'IMP 071 - TESE PENHORA FATURAMENTO - DEFERIDO',
         'IMP 072 - TESE PENHORA FATURAMENTO - AJ NOMEADO',
         'IMP 073 - TESE PENHORA FATURAMENTO - VALORES DEPOSITADOS',
         'IMP 074 - TESE PENHORA FATURAMENTO - SOLICITADO EXPEDIÇÃO DE MLE',
         'IMP 075 - TESE PENHORA FATURAMENTO - REPASSE EFETUADO',
         'IMP 071.1 - TESE PENHORA FATURAMENTO - INDEFERIDO'
    )
) AS ANDA_TESE_FATURAMENTO
    ON FP.PASTA = ANDA_TESE_FATURAMENTO.PASTA 
   AND ANDA_TESE_FATURAMENTO.RK = 1
LEFT JOIN (
    SELECT 
        ANDA.PASTA,
        ANDA.TIPO_ANDAMENTO,
        ANDA.DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY ANDA.PASTA ORDER BY ANDA.DATA_ANDAMENTO DESC, ANDA.HORA_ANDAMENTO DESC) AS RK
    FROM #TempAndamentos ANDA WITH (NOLOCK)
    INNER JOIN FICHAVAREJO FP6 WITH (NOLOCK) ON ANDA.PASTA = FP6.PASTA
    WHERE ANDA.TIPO_ANDAMENTO IN (
         'IMP 046 - PENHORA VALORES - POSITIVO',
         'IMP 100 - PESQUISA ARISP POSITIVA',
         'PESQUISA COMPLETA DE BENS - TESE DIFERENCIADA - POSITIVA',
         'IMP 046.2 - PENHORA VALORES - NEGATIVA',
         'IMP 101 - PESQUISA ARISP NEGATIVA',
         'PESQUISA COMPLETA DE BENS - TESE DIFERENCIADA - NEGATIVA'
    )
) AS ANDA_PESQUISA
    ON FP.PASTA = ANDA_PESQUISA.PASTA
   AND ANDA_PESQUISA.RK = 1
LEFT JOIN (
    SELECT 
        ANDA.PASTA,
        ANDA.TIPO_ANDAMENTO,
        ANDA.DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY ANDA.PASTA ORDER BY ANDA.DATA_ANDAMENTO DESC, ANDA.HORA_ANDAMENTO DESC) AS RK
    FROM #TempAndamentos ANDA WITH (NOLOCK)
    INNER JOIN FICHAVAREJO FP7 WITH (NOLOCK) ON ANDA.PASTA = FP7.PASTA
    WHERE ANDA.TIPO_ANDAMENTO IN (
         'IMP 037 - PENHORA IMÓVEIS - DEFERIDO',
         'IMP 041 - PENHORA MÓVEIS - DEFERIDO',
         'IMP 045 - PENHORA VALORES - DEFERIDO',
         'IMP 047 - PENHORA VALORES - SOLICITADO EXPEDIÇÃO DE MLE',
         'IMP 048 - PENHORA VALORES - REPASSE EFETUADO',
         'IMP 050 - PENHORA NO ROSTO DOS AUTOS - DEFERIDO',
         'IMP 054 - PENHORA COTAS SOCIAIS - DEFERIDA',
         'IMP 039.1 - PENHORA IMÓVEIS - DESCONSTITUÍDA',
         'IMP 042.1 - PENHORA MÓVEIS - DESCONSTITUÍDA',
         'IMP 004 - ARRESTO IMÓVEIS - REGISTRADO',
         'IMP 039 - PENHORA IMÓVEIS - REGISTRADO',
         'IMP 042 - PENHORA MÓVEIS - REGISTRADO',
         'IMP 055- PENHORA COTAS SOCIAIS - REGISTRADO',
         'IMP 021 - AVERBAÇÃO PREMONITÓRIA 828 - REGISTRADA'
    )
) AS ANDA_PENHORA_AVERBACAO
    ON FP.PASTA = ANDA_PENHORA_AVERBACAO.PASTA
   AND ANDA_PENHORA_AVERBACAO.RK = 1
LEFT JOIN (
    SELECT 
        ANDA.PASTA,
        ANDA.TIPO_ANDAMENTO,
        ANDA.DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY ANDA.PASTA ORDER BY ANDA.DATA_ANDAMENTO DESC, ANDA.HORA_ANDAMENTO DESC) AS RK
    FROM #TempAndamentos ANDA WITH (NOLOCK)
    INNER JOIN FICHAVAREJO FP8 WITH (NOLOCK) ON ANDA.PASTA = FP8.PASTA
    WHERE ANDA.TIPO_ANDAMENTO IN (
         'IMP 053 - PENHORA COTAS SOCIAIS - PETICIONADO',
         'IMP 054 - PENHORA COTAS SOCIAIS - DEFERIDA',
         'IMP 049 - PENHORA NO ROSTO DOS AUTOS - PETICIONADO',
         'IMP 050 - PENHORA NO ROSTO DOS AUTOS - DEFERIDO',
         'IMP 051 - PENHORA NO ROSTO DOS AUTOS - SOLICITADA RESERVA NOS AUTOS',
         'IMP 052 - PENHORA NO ROSTO DOS AUTOS - REPASSE EFETUADO',
         'IMP 055- PENHORA COTAS SOCIAIS - REGISTRADO',
         'IMP 044 - PENHORA VALORES - PETICIONADO',
         'IMP 045 - PENHORA VALORES - DEFERIDO',
         'IMP 046 - PENHORA VALORES - POSITIVO',
         'IMP 046.1 - PENHORA VALORES - POSITVA MENOR QUE MIL',
         'IMP 047 - PENHORA VALORES - SOLICITADO EXPEDIÇÃO DE MLE',
         'IMP 047.1 - PENHORA VALORES - VALORES DESBLOQUEADOS',
         'IMP 048 - PENHORA VALORES - REPASSE EFETUADO',
         'IMP 040 - PENHORA MÓVEIS - PETICIONADO',
         'IMP 041 - PENHORA MÓVEIS - DEFERIDO',
         'IMP 042 - PENHORA MÓVEIS - REGISTRADO',
         'IMP 042.1 - PENHORA MÓVEIS - DESCONSTITUÍDA',
         'IMP 043 - PENHORA MÓVEIS - CONVERSÃO EM PENHORA',
         'IMP 056 - LEILÃO MÓVEIS - DATA 1º LEILÃO',
         'IMP 057 - LEILÃO MÓVEIS - DATA 2º LEILÃO',
         'IMP 058 - LEILÃO MÓVEIS - PETICIONADO',
         'IMP 059 - LEILÃO MÓVEIS - DEFERIDO',
         'IMP 060 - LEILÃO MÓVEIS - POSITIVO',
         'IMP 061 - LEILÃO MÓVEIS - POSITIVO - REPASSE DE VALORES',
         'IMP 036 - PENHORA IMÓVEIS - PETICIONADO',
         'IMP 037 - PENHORA IMÓVEIS - DEFERIDO',
         'IMP 037.1 - PENHORA IMÓVEIS - INDEFERIDO',
         'IMP 037.2 - PENHORA DIREITOS AQUISITIVOS DO IMÓVEL - DEFERIDO',
         'IMP 039.1 - PENHORA IMÓVEIS - DESCONSTITUÍDA',
         'IMP 038 - PENHORA IMÓVEIS - REQUERIDO BOLETO ARISP',
         'IMP 039 - PENHORA IMÓVEIS - REGISTRADO',
         'IMP 063 - HASTA IMÓVEIS - DATA 1ª HASTA',
         'IMP 064 - HASTA IMÓVEIS - DATA 2ª HASTA',
         'IMP 065 - HASTA IMÓVEIS - PETICIONADO',
         'IMP 066 - HASTA IMÓVEIS - DEFERIDO'
    )
) AS ANDA_TIPO_PENHORA
    ON FP.PASTA = ANDA_TIPO_PENHORA.PASTA
   AND ANDA_TIPO_PENHORA.RK = 1
LEFT JOIN (
    SELECT 
        ANDA.PASTA,
        ANDA.TIPO_ANDAMENTO,
        ANDA.DATA_ANDAMENTO,
        ROW_NUMBER() OVER (PARTITION BY ANDA.PASTA ORDER BY ANDA.DATA_ANDAMENTO DESC, ANDA.HORA_ANDAMENTO DESC) AS RK
    FROM #TempAndamentos ANDA WITH (NOLOCK)
    INNER JOIN FICHAVAREJO FP9 WITH (NOLOCK) ON ANDA.PASTA = FP9.PASTA
    WHERE ANDA.TIPO_ANDAMENTO IN (
         'IMP 001 - ARRESTO IMÓVEIS - PETICIONADO',
         'IMP 007 - ARRESTO MÓVEIS - PETICIONADO',
         'IMP 012 - ARRESTO VALORES - PETICIONADO',
         'IMP 036 - PENHORA IMÓVEIS - PETICIONADO',
         'IMP 040 - PENHORA MÓVEIS - PETICIONADO',
         'IMP 044 - PENHORA VALORES - PETICIONADO',
         'IMP 049 - PENHORA NO ROSTO DOS AUTOS - PETICIONADO',
         'IMP 053 - PENHORA COTAS SOCIAIS - PETICIONADO',
         'IMP 002 - ARRESTO IMÓVEIS - DEFERIDO',
         'IMP 008 - ARRESTO MÓVEIS - DEFERIDO',
         'IMP 013 - ARRESTO VALORES - DEFERIDO',
         'IMP 037 - PENHORA IMÓVEIS - DEFERIDO',
         'IMP 041 - PENHORA MÓVEIS - DEFERIDO',
         'IMP 045 - PENHORA VALORES - DEFERIDO',
         'IMP 050 - PENHORA NO ROSTO DOS AUTOS - DEFERIDO',
         'IMP 054 - PENHORA COTAS SOCIAIS - DEFERIDO',
         'IMP 004 - ARRESTO IMÓVEIS - REGISTRADO',
         'IMP 039 - PENHORA IMÓVEIS - REGISTRADO',
         'IMP 042 - PENHORA MÓVEIS - REGISTRADO',
         'IMP 055- PENHORA COTAS SOCIAIS - REGISTRADO',
         'IMP 021 - AVERBAÇÃO PREMONITÓRIA 828 - REGISTRADA',
         'IMP 059 - LEILÃO MÓVEIS - DEFERIDO; IMP 066 - HASTA IMÓVEIS - DEFERIDO',
         'IMP 015 - ARRESTO VALORES - SOLICITADO EXPEDIÇÃO DE MLE; IMP 047 - PENHORA VALORES - SOLICITADO EXPEDIÇÃO DE MLE'
    )
) AS ANDA_TIPO_CONSTRICAO
    ON FP.PASTA = ANDA_TIPO_CONSTRICAO.PASTA
   AND ANDA_TIPO_CONSTRICAO.RK = 1
LEFT JOIN AcordoRecente AS acorven WITH (NOLOCK)
    ON FP.PASTA = acorven.nkPasta
   AND acorven.rk = 1
LEFT JOIN CTE_VALOR_PENHORA VAL_PENHORA WITH (NOLOCK)
    ON FP.PASTA = VAL_PENHORA.PASTA
LEFT JOIN CTE_CONTAGEM_TENTATIVA_CIT TENT_CIT WITH (NOLOCK)
    ON FP.PASTA = TENT_CIT.PASTA
CROSS APPLY (
    SELECT CASE
        WHEN ANDA_TESE.TIPO_ANDAMENTO = 'IMP 012 - ARRESTO VALORES - PETICIONADO' THEN 'EXECUÇÃO PURA'
        WHEN ANDA_TESE.TIPO_ANDAMENTO IN (
            'IMP 079 - TESE GRUPO ECONÔMICO - PETICIONADO',
            'IMP 080 - TESE GRUPO ECONÔMICO - DEFERIDO',
            'IMP 080.1 - TESE GRUPO ECONÔMICO - INDEFERIDO'
        ) THEN 'GRUPO ECONÔMICO FRAUDULENTO'
        WHEN ANDA_TESE.TIPO_ANDAMENTO IN (
            'IMP 085 - TESE DESCONSIDERAÇÃO INVERSA DA PERSONALIDADE JURÍDICA - PETICIONADO',
            'IMP 086 - TESE DESCONSIDERAÇÃO INVERSA DA PERSONALIDADE JURÍDICA - DEFERIDO',
            'IMP 086.1 - TESE DESCONSIDERAÇÃO INVERSA DA PERSONALIDADE JURÍDICA - INDEFERIDO'
        ) THEN 'IDPJ'
        WHEN ANDA_TESE.TIPO_ANDAMENTO IN (
            'IMP 083 - TESE FRAUDE À EXECUÇÃO - PETICIONADO',
            'IMP 084 - TESE FRAUDE À EXECUÇÃO - DEFERIDO',
            'IMP 084.1 - TESE FRAUDE À EXECUÇÃO - INDEFERIDO'
        ) THEN 'FRAUDE A EXECUÇÃO'
        WHEN ANDA_TESE.TIPO_ANDAMENTO IN (
            'IMP 076 - TESE DESVIO DE RECEBÍVEIS - PETICIONADO',
            'IMP 077 - TESE DESVIO DE RECEBÍVEIS - DEFERIDO',
            'IMP 077.1 - TESE DESVIO DE RECEBÍVEIS - INDEFERIDO'
        ) THEN 'DESVIO DE RECEBIVEIS'
        WHEN ANDA_TESE.TIPO_ANDAMENTO IN (
            'IMP 070 - TESE PENHORA FATURAMENTO - PETICIONADO',
            'IMP 071 - TESE PENHORA FATURAMENTO - DEFERIDO',
            'IMP 071.1 - TESE PENHORA FATURAMENTO - INDEFERIDO',
            'IMP 072 - TESE PENHORA FATURAMENTO - AJ NOMEADO',
            'IMP 072.1 - TESE PENHORA FATURAMENTO - DESCONSTITUÍDA',
            'IMP 073 - TESE PENHORA FATURAMENTO - VALORES DEPOSITADOS',
            'IMP 074 - TESE PENHORA FATURAMENTO - SOLICITADO EXPEDIÇÃO DE MLE',
            'IMP 075 - TESE PENHORA FATURAMENTO - REPASSE EFETUADO',
            'IMP 081 - TESE SUCESSÃO EMPRESARIAL - PETICIONADO',
            'IMP 082 - TESE SUCESSÃO EMPRESARIAL - DEFERIDO',
            'IMP 082.1 - TESE SUCESSÃO EMPRESARIAL - INDEFERIDO',
            'IMP 087 - TESE FRAUDE CONTRA CREDORES - PETICIONADO',
            'IMP 088 - TESE FRAUDE CONTRA CREDORES - DEFERIDO',
            'IMP 088.1 - TESE FRAUDE CONTRA CREDORES - INDEFERIDO',
            'IMP 089 - TESE PEDIDO DE FALÊNCIA - PETICIONADO',
            'IMP 090 - TESE PEDIDO DE FALÊNCIA - DEFERIDO',
            'IMP 090.1 - TESE PEDIDO DE FALÊNCIA - INDEFERIDO',
            'IMP 091 - TESE APREENSÃO DE PASSAPORTE - PETICIONADO',
            'IMP 092 - TESE APREENSÃO DE PASSAPORTE - DEFERIDO',
            'IMP 092.1 - TESE APREENSÃO DE PASSAPORTE - INDEFERIDO',
            'IMP 093- TESE BLOQUEIO DE CNH - PETICIONADO',
            'IMP 094 - TESE BLOQUEIO DE CNH - DEFERIDO',
            'IMP 094.1 - TESE BLOQUEIO DE CNH - INDEFERIDO',
            'IMP 095- TESE BLOQUEIO PENHORA DE MARCA E PATENTE - PETICIONADO',
            'IMP 096 - TESE BLOQUEIO PENHORA DE MARCA E PATENTE - DEFERIDO',
            'IMP 096.1 - TESE BLOQUEIO PENHORA DE MARCA E PATENTE - INDEFERIDO'
        ) THEN 'OUTROS'
        WHEN FP.TIPO_ACAO IN ('EXECUÇÃO','EXECUÇÃO DE TITULOS EXTRAJUDICIAL') THEN 'EXECUÇÃO PURA'
        ELSE 'OUTROS'
    END AS TESE_AJUIZADA_Calc
) AS Calc;

-- Drop da tabela temporária após todas as consultas
DROP TABLE IF EXISTS #TempAndamentos;