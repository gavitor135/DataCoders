WITH CTE_Ficha AS (
    SELECT 
        PASTA, 
        PRODUTO, 
        DATA_DO_AJUIZAMENTO, 
        DATA_CADASTRO_PASTA, 
        CASO_ANTIGO, 
        CASO_NOVO
    FROM JURIDICO.FichaProcessual
    WHERE PRODUTO IN (
        'RJ - ITAÚ', 'RJ - BANCO DO BRASIL', 'RJ - SANTANDER', 
        'RJ - CPFL', 'RJ - BRADESCO', 'RJ - COOPERCITRUS', 
        'RJ - VOTORANTIM', 'RJ - MERCANTIL', 'ITAÚ - RJ CORPORATE', 
        'RJ - CREDICITRUS', 'RJ - SAFRA', 'PINE - RJ CORPORATE'
    )
),
CTE_Compromissos AS (
    SELECT 
        COMP.USUARIO_CONCLUSAO_COMPROMISSO,
        COMP.DATA_CONCLUSAO_COMPROMISSO,
        COMP.TIPO_COMPROMISSO,
        COMP.CHAVECOMP,
        COMP.PASTA,
        FP.PRODUTO,
        LAG(COMP.DATA_CONCLUSAO_COMPROMISSO) OVER (
            PARTITION BY COMP.USUARIO_CONCLUSAO_COMPROMISSO 
            ORDER BY COMP.DATA_CONCLUSAO_COMPROMISSO ASC   
        ) AS DATA_CONCLUSAO_ANTERIOR
    FROM JURIDICO.Compromissos COMP
    INNER JOIN CTE_Ficha FP ON COMP.PASTA = FP.PASTA
      AND COMP.STATUS_COMPROMISSO = 'PENDENTE'
),
CTE_Tempos AS (
    SELECT 
        *,
        DATEDIFF(SECOND, DATA_CONCLUSAO_ANTERIOR, DATA_CONCLUSAO_COMPROMISSO) AS TempoSegundos
    FROM CTE_Compromissos
    WHERE DATA_CONCLUSAO_ANTERIOR IS NOT NULL
)
SELECT 
    COMPCTE.PASTA,
    COMPCTE.PRODUTO,
    COMPCTE.TIPO_COMPROMISSO,
    COMPCTE.CHAVECOMP,
    COMPCTE.USUARIO_CONCLUSAO_COMPROMISSO,
    COMPCTE.DATA_CONCLUSAO_COMPROMISSO,
    COMPCTE.DATA_CONCLUSAO_ANTERIOR,
    COMPCTE.TempoSegundos

FROM CTE_Tempos COMPCTE

SELECT *
FROM JURIDICO.COMPROMISSOS COMP 
INNER JOIN JURIDICO.FichaProcessual FP ON COMP.PASTA = FP.PASTA
WHERE FP.PRODUTO IN (        
        'RJ - ITAÚ', 'RJ - BANCO DO BRASIL', 'RJ - SANTANDER', 
        'RJ - CPFL', 'RJ - BRADESCO', 'RJ - COOPERCITRUS', 
        'RJ - VOTORANTIM', 'RJ - MERCANTIL', 'ITAÚ - RJ CORPORATE', 
        'RJ - CREDICITRUS', 'RJ - SAFRA', 'PINE - RJ CORPORATE')
AND COMP.STATUS_COMPROMISSO = 'PENDENTE'