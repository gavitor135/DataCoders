WITH CTE_Ficha AS (
    SELECT 
        PASTA, 
        PRODUTO, 
        DATA_DO_AJUIZAMENTO, 
        DATA_CADASTRO_PASTA, 
        CASO_ANTIGO, 
        CASO_NOVO
    FROM JURIDICO.FichaProcessual
),
CTE_Compromissos AS (
    SELECT 
        COMP.USUARIO_CONCLUSAO_COMPROMISSO,
        COMP.DATA_CONCLUSAO_COMPROMISSO,
        COMP.TIPO_COMPROMISSO,
        COMP.CHAVECOMP,
        COMP.PASTA,
        FP.PRODUTO,
        LAG(COMP.DATA_CONCLUSAO_COMPROMISSO) OVER (
            PARTITION BY COMP.USUARIO_CONCLUSAO_COMPROMISSO 
            ORDER BY COMP.DATA_CONCLUSAO_COMPROMISSO ASC   
        ) AS DATA_CONCLUSAO_ANTERIOR
    FROM JURIDICO.Compromissos COMP
    INNER JOIN CTE_Ficha FP ON COMP.PASTA = FP.PASTA
    WHERE COMP.DATA_LIMITE_COMPROMISSO >= '2024-01-01'
      AND COMP.STATUS_COMPROMISSO = 'CONCLUÍDO'
),
CTE_Tempos AS (
    SELECT 
        *,
        DATEDIFF(MINUTE, DATA_CONCLUSAO_ANTERIOR, DATA_CONCLUSAO_COMPROMISSO) AS TempoMinutos
    FROM CTE_Compromissos
    WHERE DATA_CONCLUSAO_ANTERIOR IS NOT NULL
)
SELECT 
    COMPCTE.PASTA,
    COMPCTE.PRODUTO,
    COMPCTE.TIPO_COMPROMISSO,
    COMPCTE.CHAVECOMP,
    REPLACE(REPLACE(REPLACE(COMPCTE.USUARIO_CONCLUSAO_COMPROMISSO,'´',''),'^',''),'~','') AS USUARIO_CONCLUSAO_COMPROMISSO,
    COMPCTE.DATA_CONCLUSAO_COMPROMISSO,
    COMPCTE.DATA_CONCLUSAO_ANTERIOR,
    COMPCTE.TempoMinutos,
    -- Formatação HH:MM:SS (horas acumuladas, mesmo acima de 24h)
    RIGHT('00' + CAST(COMPCTE.TempoMinutos / 60 AS VARCHAR), 2) + ':' +
    RIGHT('00' + CAST((COMPCTE.TempoMinutos % 60) AS VARCHAR), 2) + ':00' AS TEMPO_ENTRE_COMPROMISSOS,
    -- Cálculo da média do tempo entre compromissos por tipo de compromisso com filtro no contexto da média
    RIGHT('00' + CAST(
        AVG(CASE 
                WHEN COMPCTE.TempoMinutos BETWEEN 1 AND 90 THEN COMPCTE.TempoMinutos
                ELSE NULL
            END
        ) OVER (PARTITION BY COMPCTE.TIPO_COMPROMISSO) / 60 AS VARCHAR), 2) + ':' +
    RIGHT('00' + CAST(
        (AVG(CASE 
                WHEN COMPCTE.TempoMinutos BETWEEN 1 AND 90 THEN COMPCTE.TempoMinutos
                ELSE NULL
            END
        ) OVER (PARTITION BY COMPCTE.TIPO_COMPROMISSO) % 60) AS VARCHAR), 2) + ':00' AS MÉDIA_TEMPO
FROM CTE_Tempos COMPCTE
ORDER BY COMPCTE.USUARIO_CONCLUSAO_COMPROMISSO, COMPCTE.DATA_CONCLUSAO_COMPROMISSO;