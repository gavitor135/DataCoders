WITH CTE_FICHA AS  ( 
    SELECT
        FP.PASTA,
        FP.BJ,
        FP.AREA,
        FP.FASE,
        FP.TIPO_ACAO,
        FP.STATUS_PASTA,
        FP.PRODUTO,
        FP.CARTEIRA,
        FP.DATA_DO_AJUIZAMENTO,
        FP.DATA_CADASTRO_PASTA,
        FP.RESPONSAVEL_1,
        FP.VALOR_CAUSA
    FROM JURIDICO.FICHAPROCESSUAL FP WITH(NOLOCK)
    WHERE FP.PRODUTO = 'ITAÚ - COBRANÇA ATACADO'
),
INICIAL_PROTOCOLADA AS (
    SELECT
        ANDA.PASTA, 
        ANDA.TIPO_ANDAMENTO,
        ANDA.DATA_ANDAMENTO,
        ANDA.HORA_ANDAMENTO,
        ROW_NUMBER() OVER (
            PARTITION BY ANDA.PASTA 
            ORDER BY ANDA.DATA_ANDAMENTO, ANDA.HORA_ANDAMENTO DESC
        ) AS RK 
    FROM JURIDICO.ANDAMENTOS ANDA WITH(NOLOCK)
    WHERE ANDA.TIPO_ANDAMENTO = 'INICIAL PROTOCOLADA'
),
TIPO_DE_CITACAO AS (
    SELECT
    ANDA.PASTA,
    ANDA.TIPO_ANDAMENTO,
    ANDA.DATA_ANDAMENTO,
    ANDA.HORA_ANDAMENTO,
    ANDA.TEXTO_ANDAMENTO,
    ROW_NUMBER() OVER(
        PARTITION BY ANDA.PASTA
        ORDER BY ANDA.DATA_ANDAMENTO,ANDA.HORA_ANDAMENTO DESC
    ) AS RK
    FROM JURIDICO.ANDAMENTOS ANDA WITH(NOLOCK)
    WHERE ANDA.TIPO_ANDAMENTO  IN ('CITAÇÃO PARCIAL','CITAÇÃO POSITIVA')
),
PESQUISA_DE_BENS AS (
    SELECT
    ANDA.PASTA,
    ANDA.TIPO_ANDAMENTO,
    ANDA.DATA_ANDAMENTO,
    ANDA.HORA_ANDAMENTO,
    ANDA.TEXTO_ANDAMENTO,
    ROW_NUMBER() OVER(
        PARTITION BY ANDA.PASTA
        ORDER BY ANDA.DATA_ANDAMENTO,ANDA.HORA_ANDAMENTO DESC
    ) AS RK
    FROM JURIDICO.ANDAMENTOS ANDA WITH(NOLOCK)
    WHERE ANDA.TIPO_ANDAMENTO  = 'PESQUISA DE BENS'
),
PENHORAS AS (
    SELECT
    ANDA.PASTA,
    ANDA.TIPO_ANDAMENTO,
    ANDA.DATA_ANDAMENTO,
    ANDA.HORA_ANDAMENTO,
    ANDA.TEXTO_ANDAMENTO,
    ROW_NUMBER() OVER(
        PARTITION BY ANDA.PASTA
        ORDER BY ANDA.DATA_ANDAMENTO,ANDA.HORA_ANDAMENTO DESC
    ) AS RK
    FROM JURIDICO.ANDAMENTOS ANDA WITH(NOLOCK)
    WHERE ANDA.TIPO_ANDAMENTO  IN (
        'PENHORA DO BEM EFETIVADA - IMÓVEIS',
        'PENHORA ONLINE - POSITIVA',
        'RENAJUD - POSITIVO',
        'ARRESTO EFETIVADO - IMÓVEIS',
        'PENHORA NO ROSTO DOS AUTOS DEFERIDA',
        'PENHORA DO BEM EFETIVADA - MÓVEIS',
        'ARRESTO ONLINE - POSITIVO',
        'PENHORA DE FATURAMENTO EFETIVADA',
        'PENHORA SOBRE COTAS SOCIAIS - DEFERIDA',
        'PENHORA DE DIREITOS')
)

SELECT
    FP.*,
    IP.TIPO_ANDAMENTO   AS INICIAL_PROTOCOLADA,
    IP.DATA_ANDAMENTO   AS DATA_INICIAL_PROTOCOLADA,
    IP.HORA_ANDAMENTO   AS HORA_INICIAL_PROTOCOLADA,
    TC.TIPO_ANDAMENTO   AS TIPO_CITACAO,
    TC.DATA_ANDAMENTO   AS DATA_CITACAO,
    TC.HORA_ANDAMENTO   AS HORA_CITACAO,
    TC.TEXTO_ANDAMENTO  AS TEXTO_CITACAO,
    PB.TIPO_ANDAMENTO   AS PESQUISA_DE_BENS,
    PB.DATA_ANDAMENTO   AS DATA_PESQUISA_DE_BENS,
    PB.TEXTO_ANDAMENTO  AS TEXTO_PESQUISA_DE_BENS,
    PEN.TIPO_ANDAMENTO  AS TIPO_PENHORA,
    PEN.DATA_ANDAMENTO  AS DATA_PENHORA,
    PEN.TEXTO_ANDAMENTO AS TEXTO_PENHORA,

-- Indicador de existência da citação
CASE 
    WHEN TC.TIPO_ANDAMENTO IS NOT NULL THEN 'SIM'
    ELSE 'NÃO'
END AS [CITAÇÃO?],

-- Classificação do prazo de citação
CASE 
    WHEN TC.DATA_ANDAMENTO IS NULL THEN NULL
    WHEN IP.DATA_ANDAMENTO IS NOT NULL THEN
        CASE
            WHEN DATEDIFF(DAY, TC.DATA_ANDAMENTO, IP.DATA_ANDAMENTO) <= 45 THEN 'PRAZO 45 DIAS'
            WHEN DATEDIFF(DAY, TC.DATA_ANDAMENTO, IP.DATA_ANDAMENTO) <= 90 THEN 'PRAZO 90 DIAS'
            WHEN DATEDIFF(DAY, TC.DATA_ANDAMENTO, IP.DATA_ANDAMENTO) <= 120 THEN 'PRAZO 120 DIAS'
            ELSE NULL
        END
    ELSE
        CASE
            WHEN DATEDIFF(DAY, TC.DATA_ANDAMENTO, FP.DATA_DO_AJUIZAMENTO) <= 45 THEN 'PRAZO 45 DIAS'
            WHEN DATEDIFF(DAY, TC.DATA_ANDAMENTO, FP.DATA_DO_AJUIZAMENTO) <= 90 THEN 'PRAZO 90 DIAS'
            WHEN DATEDIFF(DAY, TC.DATA_ANDAMENTO, FP.DATA_DO_AJUIZAMENTO) <= 120 THEN 'PRAZO 120 DIAS'
            ELSE NULL
        END
END AS PRAZO_CITACAO,

CASE 
    WHEN TC.DATA_ANDAMENTO IS NULL THEN
    DATEADD(DAY,45,FP.DATA_CADASTRO_PASTA)
    ELSE NULL
    END AS PRAZO_CITACAO_45_DIAS,

CASE 
    WHEN TC.DATA_ANDAMENTO IS NULL THEN
    DATEADD(DAY,90,FP.DATA_CADASTRO_PASTA)
    ELSE NULL
    END AS PRAZO_CITACAO_90_DIAS,

CASE 
    WHEN TC.DATA_ANDAMENTO IS NULL THEN
    DATEADD(DAY,120,FP.DATA_CADASTRO_PASTA)
    ELSE NULL
    END AS PRAZO_CITACAO_120_DIAS

FROM CTE_FICHA FP
LEFT JOIN INICIAL_PROTOCOLADA IP 
    ON FP.PASTA = IP.PASTA AND IP.RK = 1
LEFT JOIN TIPO_DE_CITACAO TC
    ON FP.PASTA = TC.PASTA AND TC.RK = 1
LEFT JOIN PESQUISA_DE_BENS PB
    ON FP.PASTA = PB.PASTA AND PB.RK = 1
LEFT JOIN PENHORAS PEN
    ON FP.PASTA = PEN.PASTA AND PEN.RK = 1
