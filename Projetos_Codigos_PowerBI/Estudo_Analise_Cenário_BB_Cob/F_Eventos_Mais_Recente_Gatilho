SELECT
    ficha.pasta AS 'PASTA',
    ficha.data_do_ajuizamento as 'DATA_DO_AJUIZAMENTO',
    CLI.cpfcnpjcliente AS 'CNPJ_PARTE',
    an.data_andamento AS 'DATA_ANDAMENTO_MAIS_RECENTE',
    an.tipo_andamento AS 'TIPO_ANDAMENTO_MAIS_RECENTE',
    eventos.nkEvento AS 'NKEVENTO',
    eventos.dataEventoCliente AS 'DATA_EVENTO_MAIS_RECENTE',
	
	CASE 
        WHEN AN.TIPO_ANDAMENTO IN (
            -- ANDAMENTOS DE PENHORA DEFERIDA
        'PENHORA DE FATURAMENTO DEFERIDA',
        'PENHORA DE FATURAMENTO EFETIVADA',
        'PENHORA DO BEM DEFERIDA',
        'PENHORA DO BEM DEFERIDA - IMÓVEIS',
        'PENHORA DO BEM EFETIVADA',
        'PENHORA DO BEM EFETIVADA - IMÓVEIS',
        'PENHORA DO BEM EFETIVADA - IMÓVEL GARANTIA',
        'PENHORA DO BEM EFETIVADA - MÓVEIS',
        'PENHORA IMÓVEL - BOLETO ARISP',
        'PENHORA NO ROSTO DOS AUTOS DEFERIDA',
        'PENHORA ONLINE - POSITIVA',
        'PENHORA QUALIFICADA',
        'PETIÇÃO DE HOMOLOGAÇÃO DA AVALIAÇÃO',
        'PETIÇÃO INFORMANDO DADOS BOLETO ARISP',
        'PETIÇÃO REQUERENDO REGISTRO DA PENHORA DE IMÓVEIS - ARISP',
        'PETICIONAMOS PELA AVALIAÇÃO DO BEM',
        'PETICIONAMOS PELA AVALIAÇÃO DOS BENS',
        'PETICIONAMOS PELA AVALIAÇÃO E PRACEAMENTO DOS BENS',
        'PETICIONAMOS PELA DESIGNAÇÃO DE HASTA',
        'PETICIONAMOS PELA DESIGNAÇÃO DE HASTA - IMÓVEIS',
        'PETICIONAMOS PELA DESIGNAÇÃO DE HASTA - VEÍCULOS',
        'PETICIONAR REQUERENDO AVALIAÇÃO PELO OJ',
        'PETICIONAR REQUERENDO NOMEAÇÃO DE PERITO AVALIADOR',
        'RENAJUD - POSITIVO',
        'SOLICITAÇÃO DE PAGAMENTO – BOLETO ARISP',
        'SUSEP POSITIVA',
        'VEÍCULO REINTEGRADO/APREENDIDO',
        'SOLICITAÇÃO DE AVALIAÇÃO DE IMÓVEL',
        'PENHORA DEFERIDA',
        'INTIMAÇÃO PARCIAL - PENHORA',
        'INTIMAÇÃO POSITIVA - PENHORA',
        'EDITAL DE INTIMACAO DE PENHORA',
        'EMBARGOS DE TERCEIROS - SENTENÇA EXTINÇÃO SEM MÉRITO',
        'EMBARGOS DE TERCEIROS - SENTENÇA IMPROCEDENTE',
        'CARTA PRECATÓRIA EM CUMPRIMENTO - AVALIAÇÃO DE IMÓVEL',
        'CAGED POSITIVO',
        'AVERBAÇÃO DA PENHORA CONCLUÍDA',
        'BEM APREENDIDO',
        'APREENSÃO COM CITAÇÃO',
        'AGUARDANDO EXPEDIÇÃO DO TERMO DE PENHORA',
        'ACOMPANHAMENTO - PENHORA BB')  THEN 'PENHORA DEFERIDA'

        -- ANDAMENTOS DE PEDIDO DE PENHORA
        WHEN AN.TIPO_ANDAMENTO IN(
        'INDICAÇÃO DE BENS - PENHORA BB',
        'INDICAÇÃO DE BENS À PENHORA',
        'PENHORA ON-LINE - TEIMOSINHA',
        'PETIÇÃO DE BLOQUEIO DE VEÍCULOS - RENAJUD',
        'PETICAO DE JUNTADA DE BLOQUEIO DE COTAS',
        'PETIÇÃO DE PENHORA',
        'PETIÇÃO DE PENHORA DOS DIREITOS – BENS IMÓVEIS',
        'PETIÇÃO DE PENHORA DOS DIREITOS – BENS MÓVEIS',
        'PETIÇÃO DE PENHORA ON-LINE DE IMÓVEIS - ARISP',
        'PETIÇÃO DE PENHORA POR TERMO',
        'PETIÇÃO DE PENHORA SOBRE COTAS SOCIAIS',
        'PETIÇÃO REQUERENDO A PENHORA DO FATURAMENTO',
        'PETICIONAMOS PELA DESIGNAÇÃO DE HASTA PUBLICA',
        'PETICIONAMOS PELA PENHORA DE BENS IMÓVEIS',
        'PETICIONAMOS PELA PENHORA DE BENS MÓVEIS',
        'PETICIONAMOS PELA PENHORA DE FATURAMENTO',
        'PETICIONAMOS REQUERENDO A PENHORA NO ROSTO DOS AUTOS',
        'AGUARDANDO DEFERIMENTO - PENHORA IMÓVEIS') THEN 'PEDIDO DE PENHORA'

        -- ANDAMENTOS DE MLE
        WHEN AN.TIPO_ANDAMENTO IN(
        'MLE LEVANTADO',
        'MLJ LEVANTADO',
        'PETIÇÃO DE EXPEDIÇÃO DE MLE',
        'PETIÇÃO DE EXPEDIÇÃO DE MLJ',
        'PETIÇÃO DE EXPEDIÇÃO DE MLJ - MLE',
        'PETICIONAMOS PELA EXPEDIÇÃO DE ALVARÁ JUDICIAL',
        'LEVANTAMENTO DE PENHORA EM DINHEIRO',
        'DEVOLUÇÃO DMI BB RATEIO',
        'AMORTIZAÇÃO DO VALOR EXEQUENDO',
        'ANOTAÇÃO DMI BB RATEIO',
        'ANOTAÇÃO DMI BB RATEIO / ATUALIZAÇÃO',
        'AGUARDANDO EXPEDIR MANDADO DE LEVANTAMENTO JUDICIAL',
        'ACOMPANHAR DEFERIMENTO DE MLJ/MLE',
        'AGUARDANDO EXPEDIÇÃO DO MANDADO DE LEVANTAMENTO ELETRÔNICO',
        'ACOMPANHAMENTO MLJ/ MLE',
        'ACOMPANHAMENTO MLJ/ MLE – IMPUGNAÇÃO') THEN 'MLE'

        -- ANDAMENTO DE PESQUISA DE BENS

        WHEN AN.TIPO_ANDAMENTO IN('INFOJUD IR - POSITIVO',
        'PESQUISA COMPLETA DE BENS',
        'PETIÇÃO DE EXPEDIÇÃO DE OFÍCIO – NFP',
        'PETIÇÃO DE PENHORA ON-LINE - BACENJUD',
        'PETIÇÃO REQUERENDO A PESQUISA DE BENS',
        'PETIÇÃO REQUERENDO OFICIO SUSEP',
        'PETIÇÃO REQUERENDO PENHORA ON-LINE',
        'PETICAO REQUERENDO PESQUISA BACEN JUD E INFOJUD',
        'PETICAO REQUERENDO PESQUISA BACEN JUD E RENAJUD',
        'PETIÇÃO REQUERENDO PESQUISA DE VEÍCULOS',
        'PETIÇÃO REQUERENDO PESQUISA INFOJUD',
        'PETICAO REQUERENDO PESQUISA RENAJUD E INFOJUD') THEN 'PESQUISA DE BENS'

        -- ANDAMENTO DE HASTA PUBLICA

        WHEN AN.TIPO_ANDAMENTO IN (
        'HASTA PÚBLICA - POSITIVA',
        'HASTA PÚBLICA - POSITIVA/NEGATIVA',
        'HASTA PÚBLICA MARCADA',
        'HASTA PÚBLICA REMARCADA',
        'ACOMPANHAMENTO DESIGNAÇÃO DE LEILÃO') THEN 'HASTA PUBLICA'

        -- ANDAMENTO DE PEDIDO DE ARRESTO

        WHEN AN.TIPO_ANDAMENTO IN (
        'PETIÇÃO DE ARRESTO ON-LINE - BACENJUD',
        'PETIÇÃO DE ARRESTO ON-LINE DE IMÓVEIS - ARISP',
        'PETIÇÃO REQUERENDO ARRESTO ON-LINE') THEN 'PEDIDO DE ARRESTO'


        -- ANDAMENTO DE 828

        WHEN AN.TIPO_ANDAMENTO IN (
        'BOLETO AVERBAÇÃO ARISP - ARTIGO 828 CPC',
        'AVERBAÇÃO PREMONITÓRIA - AVERBADA',
        'AVERBAÇÃO PREMONITÓRIA - SOLICITADA') THEN '828'

        -- ANDAMENTO DE ARRESTO
        WHEN AN.TIPO_ANDAMENTO IN (
        'ARRESTO REQUERIDO') THEN 'ARRESTO'

        -- ANDAMENTO DE DEVEDOR PERDEU EMBARGOS',
        WHEN AN.TIPO_ANDAMENTO IN (
        'EMBARGOS À EXECUÇÃO - SENTENÇA IMPROCEDENTE',
        'EMBARGOS À EXECUÇÃO - SENTENÇA EXTINÇÃO SEM MÉRITO') THEN 'DEVEDOR PERDEU EMBARGOS'

        -- ANDAMENTO DE CITAÇÃO
        WHEN AN.TIPO_ANDAMENTO IN (
        'CITAÇÃO PARCIAL',
        'CITAÇÃO POSITIVA') THEN 'CITAÇÃO'

        --ANDAMENTO DE DEVEDOR PERDEU FASE DE CONHECIMENTO',
        WHEN AN.TIPO_ANDAMENTO IN (
        'SENTENÇA PROCEDENTE',
        'SENTENÇA PARCIALMENTE PROCEDENTE') THEN 'DEVEDOR PERDEU FASE DE CONHECIMENTO'

        -- ANDAMENTO DE ARREMATAÇÃO
        WHEN AN.TIPO_ANDAMENTO IN (
        'ARREMATAÇÃO',
        'CARTA DE ARREMATACAO',
        'HASTA PÚBLICA REALIZADA - BENS ARREMATADOS',
        'IMÓVEL ARREMATADO') THEN 'ARREMATAÇÃO'

        -- ANDAMENTO DE CUMPRIMENTO DE SENTENÇA
        WHEN AN.TIPO_ANDAMENTO IN (
        'EXECUÇÃO DE SENTENÇA',
        'INTIMAÇÃO PARCIAL – CUMPRIMENTO DE SENTENÇA',
        'INTIMAÇÃO POSITIVA - CUMPRIMENTO DE SENTENÇA',
        'EDITAL DE INTIMAÇÃO',
        'CUMPRIMENTO DE SENTENÇA',
        'CUMPRIMENTO DE SENTENÇA - BANCO EXEQUENTE') THEN 'CUMPRIMENTO DE SENTENÇA'
        ELSE 'OUTROS'
        END AS 'AGRUPADOR'

FROM
    juridico.fichaProcessual as ficha with (nolock)
    LEFT JOIN (
        SELECT
            a.pasta,
            a.data_andamento,
            a.tipo_andamento,
            a.hora_andamento,
            RANK() OVER (PARTITION BY a.pasta ORDER BY a.data_andamento DESC, a.hora_andamento DESC) AS rn
        FROM juridico.andamentos AS a WITH (NOLOCK)
        WHERE a.tipo_andamento IN ( 

        -- ANDAMENTOS DE PENHORA DEFERIDA
        'PENHORA DE FATURAMENTO DEFERIDA',
        'PENHORA DE FATURAMENTO EFETIVADA',
        'PENHORA DO BEM DEFERIDA',
        'PENHORA DO BEM DEFERIDA - IMÓVEIS',
        'PENHORA DO BEM EFETIVADA',
        'PENHORA DO BEM EFETIVADA - IMÓVEIS',
        'PENHORA DO BEM EFETIVADA - IMÓVEL GARANTIA',
        'PENHORA DO BEM EFETIVADA - MÓVEIS',
        'PENHORA IMÓVEL - BOLETO ARISP',
        'PENHORA NO ROSTO DOS AUTOS DEFERIDA',
        'PENHORA ONLINE - POSITIVA',
        'PENHORA QUALIFICADA',
        'PETIÇÃO DE HOMOLOGAÇÃO DA AVALIAÇÃO',
        'PETIÇÃO INFORMANDO DADOS BOLETO ARISP',
        'PETIÇÃO REQUERENDO REGISTRO DA PENHORA DE IMÓVEIS - ARISP',
        'PETICIONAMOS PELA AVALIAÇÃO DO BEM',
        'PETICIONAMOS PELA AVALIAÇÃO DOS BENS',
        'PETICIONAMOS PELA AVALIAÇÃO E PRACEAMENTO DOS BENS',
        'PETICIONAMOS PELA DESIGNAÇÃO DE HASTA',
        'PETICIONAMOS PELA DESIGNAÇÃO DE HASTA - IMÓVEIS',
        'PETICIONAMOS PELA DESIGNAÇÃO DE HASTA - VEÍCULOS',
        'PETICIONAR REQUERENDO AVALIAÇÃO PELO OJ',
        'PETICIONAR REQUERENDO NOMEAÇÃO DE PERITO AVALIADOR',
        'RENAJUD - POSITIVO',
        'SOLICITAÇÃO DE PAGAMENTO – BOLETO ARISP',
        'SUSEP POSITIVA',
        'VEÍCULO REINTEGRADO/APREENDIDO',
        'SOLICITAÇÃO DE AVALIAÇÃO DE IMÓVEL',
        'PENHORA DEFERIDA',
        'INTIMAÇÃO PARCIAL - PENHORA',
        'INTIMAÇÃO POSITIVA - PENHORA',
        'EDITAL DE INTIMACAO DE PENHORA',
        'EMBARGOS DE TERCEIROS - SENTENÇA EXTINÇÃO SEM MÉRITO',
        'EMBARGOS DE TERCEIROS - SENTENÇA IMPROCEDENTE',
        'CARTA PRECATÓRIA EM CUMPRIMENTO - AVALIAÇÃO DE IMÓVEL',
        'CAGED POSITIVO',
        'AVERBAÇÃO DA PENHORA CONCLUÍDA',
        'BEM APREENDIDO',
        'APREENSÃO COM CITAÇÃO',
        'AGUARDANDO EXPEDIÇÃO DO TERMO DE PENHORA',
        'ACOMPANHAMENTO - PENHORA BB',

        -- ANDAMENTOS DE PEDIDO DE PENHORA
        'INDICAÇÃO DE BENS - PENHORA BB',
        'INDICAÇÃO DE BENS À PENHORA',
        'PENHORA ON-LINE - TEIMOSINHA',
        'PETIÇÃO DE BLOQUEIO DE VEÍCULOS - RENAJUD',
        'PETICAO DE JUNTADA DE BLOQUEIO DE COTAS',
        'PETIÇÃO DE PENHORA',
        'PETIÇÃO DE PENHORA DOS DIREITOS – BENS IMÓVEIS',
        'PETIÇÃO DE PENHORA DOS DIREITOS – BENS MÓVEIS',
        'PETIÇÃO DE PENHORA ON-LINE DE IMÓVEIS - ARISP',
        'PETIÇÃO DE PENHORA POR TERMO',
        'PETIÇÃO DE PENHORA SOBRE COTAS SOCIAIS',
        'PETIÇÃO REQUERENDO A PENHORA DO FATURAMENTO',
        'PETICIONAMOS PELA DESIGNAÇÃO DE HASTA PUBLICA',
        'PETICIONAMOS PELA PENHORA DE BENS IMÓVEIS',
        'PETICIONAMOS PELA PENHORA DE BENS MÓVEIS',
        'PETICIONAMOS PELA PENHORA DE FATURAMENTO',
        'PETICIONAMOS REQUERENDO A PENHORA NO ROSTO DOS AUTOS',
        'AGUARDANDO DEFERIMENTO - PENHORA IMÓVEIS',

        -- ANDAMENTOS DE MLE
        'MLE LEVANTADO',
        'MLJ LEVANTADO',
        'PETIÇÃO DE EXPEDIÇÃO DE MLE',
        'PETIÇÃO DE EXPEDIÇÃO DE MLJ',
        'PETIÇÃO DE EXPEDIÇÃO DE MLJ - MLE',
        'PETICIONAMOS PELA EXPEDIÇÃO DE ALVARÁ JUDICIAL',
        'LEVANTAMENTO DE PENHORA EM DINHEIRO',
        'DEVOLUÇÃO DMI BB RATEIO',
        'AMORTIZAÇÃO DO VALOR EXEQUENDO',
        'ANOTAÇÃO DMI BB RATEIO',
        'ANOTAÇÃO DMI BB RATEIO / ATUALIZAÇÃO',
        'AGUARDANDO EXPEDIR MANDADO DE LEVANTAMENTO JUDICIAL',
        'ACOMPANHAR DEFERIMENTO DE MLJ/MLE',
        'AGUARDANDO EXPEDIÇÃO DO MANDADO DE LEVANTAMENTO ELETRÔNICO',
        'ACOMPANHAMENTO MLJ/ MLE',
        'ACOMPANHAMENTO MLJ/ MLE – IMPUGNAÇÃO',

        -- ANDAMENTO DE PESQUISA DE BENS

        'INFOJUD IR - POSITIVO',
        'PESQUISA COMPLETA DE BENS',
        'PETIÇÃO DE EXPEDIÇÃO DE OFÍCIO – NFP',
        'PETIÇÃO DE PENHORA ON-LINE - BACENJUD',
        'PETIÇÃO REQUERENDO A PESQUISA DE BENS',
        'PETIÇÃO REQUERENDO OFICIO SUSEP',
        'PETIÇÃO REQUERENDO PENHORA ON-LINE',
        'PETICAO REQUERENDO PESQUISA BACEN JUD E INFOJUD',
        'PETICAO REQUERENDO PESQUISA BACEN JUD E RENAJUD',
        'PETIÇÃO REQUERENDO PESQUISA DE VEÍCULOS',
        'PETIÇÃO REQUERENDO PESQUISA INFOJUD',
        'PETICAO REQUERENDO PESQUISA RENAJUD E INFOJUD',

        -- ANDAMENTO DE HASTA PUBLICA

        'HASTA PÚBLICA - POSITIVA',
        'HASTA PÚBLICA - POSITIVA/NEGATIVA',
        'HASTA PÚBLICA MARCADA',
        'HASTA PÚBLICA REMARCADA',
        'ACOMPANHAMENTO DESIGNAÇÃO DE LEILÃO',


        -- ANDAMENTO DE PEDIDO DE ARRESTO

        'PETIÇÃO DE ARRESTO ON-LINE - BACENJUD',
        'PETIÇÃO DE ARRESTO ON-LINE DE IMÓVEIS - ARISP',
        'PETIÇÃO REQUERENDO ARRESTO ON-LINE',


        -- ANDAMENTO DE 828

        'BOLETO AVERBAÇÃO ARISP - ARTIGO 828 CPC',
        'AVERBAÇÃO PREMONITÓRIA - AVERBADA',
        'AVERBAÇÃO PREMONITÓRIA - SOLICITADA',

        -- ANDAMENTO DE ARRESTO

        'ARRESTO REQUERIDO',

        -- ANDAMENTO DE DEVEDOR PERDEU EMBARGOS',

        'EMBARGOS À EXECUÇÃO - SENTENÇA IMPROCEDENTE',
        'EMBARGOS À EXECUÇÃO - SENTENÇA EXTINÇÃO SEM MÉRITO',

        -- ANDAMENTO DE CITAÇÃO

        'CITAÇÃO PARCIAL',
        'CITAÇÃO POSITIVA',

        --ANDAMENTO DE DEVEDOR PERDEU FASE DE CONHECIMENTO',

        'SENTENÇA PROCEDENTE',
        'SENTENÇA PARCIALMENTE PROCEDENTE',

        -- ANDAMENTO DE ARREMATAÇÃO

        'ARREMATAÇÃO',
        'CARTA DE ARREMATACAO',
        'HASTA PÚBLICA REALIZADA - BENS ARREMATADOS',
        'IMÓVEL ARREMATADO',

        -- ANDAMENTO DE CUMPRIMENTO DE SENTENÇA

        'EXECUÇÃO DE SENTENÇA',
        'INTIMAÇÃO PARCIAL – CUMPRIMENTO DE SENTENÇA',
        'INTIMAÇÃO POSITIVA - CUMPRIMENTO DE SENTENÇA',
        'EDITAL DE INTIMAÇÃO',
        'CUMPRIMENTO DE SENTENÇA',
        'CUMPRIMENTO DE SENTENÇA - BANCO EXEQUENTE')
    ) AS an ON ficha.pasta = an.pasta AND an.rn = 1   
    LEFT join negocial.COB_Contrato as con with (nolock) on ficha.pasta = con.nkPasta
    LEFT JOIN negocial.COB_Cliente AS cli WITH (NOLOCK) ON CON.nkCliente = cli.nkCliente
LEFT JOIN (
    SELECT
        evc.nkEvento,
        cli.cpfcnpjcliente,
        contr.nkPasta,
        evc.dataEventoCliente,
        ROW_NUMBER() OVER (PARTITION BY cli.cpfcnpjcliente ORDER BY evc.dataEventoCliente DESC) AS rk
    FROM
        negocial.COB_clienteEvento AS evc WITH (NOLOCK)
        LEFT JOIN negocial.COB_Evento AS eve WITH (NOLOCK) ON evc.nkEvento = eve.nkEvento
        LEFT JOIN negocial.COB_Cliente AS cli WITH (NOLOCK) ON evc.nkCliente = cli.nkCliente
        LEFT JOIN negocial.COB_Contrato AS contr WITH (NOLOCK) ON cli.nkCliente = contr.nkCliente
) AS eventos ON eventos.nkpasta = con.nkpasta AND eventos.rk = 1
                and eventos.rk = 1
    WHERE FICHA.PRODUTO IN(
    'BANCO DO BRASIL - COBRANÇA - ATIPICAS',
    'BANCO DO BRASIL - COBRANÇA - SEGMENTO 1',
    'BANCO DO BRASIL - COBRANÇA - SEGMENTO 2',
    'BANCO DO BRASIL - COBRANÇA - SEGMENTO 3',
    'BB - COBRANÇA')
