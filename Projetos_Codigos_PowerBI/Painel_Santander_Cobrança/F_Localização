SELECT
    ficha.pasta,
    ficha.CNPJ_PARTE_ADVERSA,
    con.numeroContrato,
    CASE
        WHEN cl.nkContrato IS NOT NULL THEN 'Localizado'
        ELSE 'Não Localizado'
    END AS Localizado
FROM
    juridico.fichaProcessual AS ficha WITH (NOLOCK)
    LEFT JOIN negocial.COB_Contrato AS con WITH (NOLOCK) ON ficha.pasta = con.nkPasta
    LEFT JOIN (
        SELECT 
            con2.nkContrato,
            cli.cpfcnpjcliente,
            con2.numeroContrato
        FROM
            negocial.COB_Contrato AS con2 WITH (NOLOCK)
            LEFT JOIN negocial.COB_Negociacao AS neg WITH (NOLOCK) ON con2.nkContrato = neg.nkContrato
            LEFT JOIN negocial.COB_eventoNegociacao AS evcNeg WITH (NOLOCK) ON neg.nkNegociacao = evcNeg.nkNegociacao
            LEFT JOIN negocial.COB_clienteEvento AS evc WITH (NOLOCK) ON evcNeg.nkClienteEvento = evc.nkClienteEvento
            LEFT JOIN negocial.COB_Cliente AS cli WITH (NOLOCK) ON evc.NkCliente = cli.NkCliente
            LEFT JOIN negocial.COB_Evento AS eve WITH (NOLOCK) ON evc.nkEvento = eve.nkEvento
        WHERE
            eve.Evento IN (
'Contato Com Cliente',
'Agendamento',
'Alega Pagamento',
'Acordo',
'Acordo Aguardando Aprovação',
'Acordo Aprovado',
'Contato Receptivo',
'Nao Reconhece Debito',
'Sem Condições de Pagamento',
'Acordo - Em Aprovação no Credor',
'Proposta de Acordo',
'Acordo Aprovado Credor',
'Oferta de Acordo',
'Proposta enviada',
'Pós - Parc Atrasada - Promessa de Pgto',
'Pós - Par Atrasada - Em Negociação',
'Pós - Parc Atrasada - Sem Condições',
'Pós - Parc Atrasada - Sem Interesse',
'Pós - Parcela em Dia',
'Pós - Parcela Regularizada',
'Alega Ação Contra',
'Alega Desemprego',
'N.A - Proposta em Análise pelo Cliente',
'N.A - Cliente Ofertou Contra Proposta',
'N.A - Banco Ofertou Contra Proposta',
'Sem Interesse',
'Cliente Recusa Passar Dados',
'WhatsApp - Contato Com Cliente',
'Pós - Preventivo - Promessa de Pgto',
'Início de Tratativas',
'Possibilidade de Negócio',
'N.A - Negociação Avançada',
'N.A - Proposta em Análise pelo Banco',
'N.A - Aguardando Pagamento do Cliente',
'N.A - Discorda da Proposta',
'Cliente Localizado',
'Cliente Atritado',
'Pós - Preventivo - Sem Previsão de Pgto',
'N.A - Aguardando Parâmetros do Cliente',
'N.A - Aguardando Documentação do Cliente',
'N.A - Aguardando Documentação do Banco',
'N.A - Aguardando Minuta do Banco',
'N.A - Aguardando Parâmetros do Banco',
'N.A - Aguardando Proposta do Banco',
'N.A - Aguardando Orientação do Banco',
'Acordo Formalizado',
'Contato Com Cliente',
'Contato Com Advogado',
'N.A - Aguardando Resposta do Banco',
'N.A - Acordo Formalizado',
'WhatsApp - Contato Com Advogado',
'Promessa Pgto - À Vista',
'Promessa Pgto - Parcelado',
'Cliente Alega Pagamento',
'Retorno - CPC',
'Cessão de Credito em Análise',
'Agendado Para Mutirão',
'Sem Condições',
'Não Reconhece a Dívida',
'Ligação Receptiva',
'Pagamento - Aguardando Minuta',
'BB-Rastreamento Minuta',
'Cliente Alega Acordo Anterior',
'BB-Contato Com Cliente',
'BB-Não Indicado Para Acordo',
'BB-Retornar',
'BB-Acompanhamento RJ',
'BB-Alega Ação Contra',
'BB-Cliente Atritado-Intensidade Contatos',
'BB-N.A - Aguardando Documentação Cliente',
'BB-N.A-Aguardando Orientação do Jurídico',
'BB-N.A - Aguardando Resposta do Banco',
'BB-N.A - Aguardando Pagamento do Cliente',
'BB-Acordo Formalizado',
'BB-N.A - Discorda da Proposta',
'BB-N.A - Negociação Avançada',
'BB-N.A- Proposta em Análise pelo Cliente',
'BB-Não Reconhece a Dívida',
'BB-Pós - Parcela em Dia',
'BB-Possibilidade de Negócio',
'BB-Sem Condições',
'BB-Sem Interesse',
'BB-Acordo Cadastrado',
'BB-Quebra de Acordo',
'BB-Cancelamento de Proposta de Acordo',
'BB-Proposta de Acordo',
'BB-Acordo Cadastrado - À Vista',
'BB-N.A - Proposta em Análise pelo Banco',
'BB-Cliente Localizado',
'BB-N.A - Aguardando Documentação Banco',
'BB-N.A - Aguardando Parâmetros do Banco',
'BB-Ligação Receptiva',
'BB-N.A-Aguardando Parâmetros do Cliente',
'BB-N.A-Aguardando Orientação do Banco',
'BB-N.A- Aguardando tratamento judiciário',
'Em Negociação - Telefone',
'Em Negociação - Multicanalidade',
'Em Negociação - Rede Comercial',
'Sem Condições - Telefone',
'Sem Condições - Multicanalidade',
'Sem Interesse - Telefone',
'Sem Interesse - Multicanalidade',
'Proposta Expurgada - Desistiu do acordo',
'Proposta Expurgada - Parou de atender',
'Proposta em Análise cadastrada pela rede',
'N.A - Aguardando Parecer da Rede',
'N.A -Proposta Negada pelo Banco',
'Cliente Solicita Retorno',
'Cliente confirma dados - queda ligação',
'BB - Cliente Agendado Para Evento',
'CONTATO MULTICANALIDADE',
'Entrega amigável - Inicio de Tratativas',
'Entrega amigável em andamento',
'Entrega amigável concluída',
'Conv entrega amigável Inicio Tratativas',
'Conv entrega amigável em andamento',
'Conv em entrega amigável concluída',
'Fidelizados Expirados',
'BB-N.A - Tratamento Diferenciado',
'BB-N.A - Exaustão Patrimonial',
'Gerente negociação',
'Visita frutífera',
'Retorno de Ação Email Frutífera',
'N.A - Proposta em Análise Cliente ALTA',
'N.A - Proposta em Análise Cliente BAIXA',
'N.A - Proposta em Análise Cliente MEDIA',
'BB-Cliente confirma dados-queda ligacao'
            )
            AND DATEDIFF(DAY, evc.dataEventoCliente, GETDATE()) <= 90
    ) AS cl ON con.nkContrato = cl.nkContrato AND con.numeroContrato = cl.numeroContrato
WHERE
    ficha.Produto IN('SANTANDER - AÇÕES ESPECIAIS','SANTANDER - ESPECIALIZADO AGRONEGOCIO','SANTANDER - VAREJO')
